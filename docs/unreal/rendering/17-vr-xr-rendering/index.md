# Ch.17 VR/XR 렌더링

VR(Virtual Reality), AR(Augmented Reality), MR(Mixed Reality)을 위한 렌더링 시스템을 분석합니다.

---

## 개요

XR 렌더링은 높은 프레임레이트와 저지연을 요구하는 특수한 렌더링 환경입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    XR 렌더링 요구사항                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    성능 요구사항                         │   │
│  │                                                          │   │
│  │  프레임레이트:                                           │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │ Quest 2/3:      72/90/120 Hz                   │    │   │
│  │  │ PSVR 2:         90/120 Hz                      │    │   │
│  │  │ PC VR:          90 Hz (최소)                    │    │   │
│  │  │ Apple Vision:   90 Hz                          │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                          │   │
│  │  지연 (Motion-to-Photon):                                │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │ 목표: < 20ms                                    │    │   │
│  │  │ 이상: < 11ms (90 Hz 기준)                       │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  렌더링 도전 과제:                                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                          │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │   │
│  │  │ 스테레오     │  │ 고해상도    │  │ 저지연       │   │   │
│  │  │ 렌더링      │  │ 렌더링      │  │ 요구         │   │   │
│  │  ├──────────────┤  ├──────────────┤  ├──────────────┤   │   │
│  │  │ 양안 각각   │  │ 눈당        │  │ 센서→화면   │   │   │
│  │  │ 렌더링 필요 │  │ 2K+ 해상도  │  │ 지연 최소화  │   │   │
│  │  │ (2배 부하)  │  │             │  │             │   │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘   │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## XR 플랫폼

### 지원 플랫폼

| 플랫폼 | 유형 | 해상도 (눈당) | 주사율 |
|--------|------|---------------|--------|
| **Meta Quest 3** | Standalone | 2064×2208 | 72/90/120 Hz |
| **PSVR 2** | Tethered | 2000×2040 | 90/120 Hz |
| **Valve Index** | PC VR | 1440×1600 | 90/120/144 Hz |
| **Apple Vision Pro** | Standalone | 3660×3200 | 90 Hz |
| **HoloLens 2** | AR | 2048×1080 | 60 Hz |

### UE XR 플러그인

```cpp
// 주요 XR 플러그인
// OpenXR (표준)
// - 크로스 플랫폼 XR 표준
// - Quest, SteamVR, WMR 지원

// OculusVR (Meta)
// - Quest 네이티브 지원
// - ASW, 컴포지터 레이어

// SteamVR
// - Valve Index, HTC Vive
// - Motion Smoothing

// 프로젝트 설정
[/Script/Engine.RendererSettings]
vr.InstancedStereo=True
vr.MobileMultiView=True
vr.RoundRobinOcclusion=True
```

---

## 스테레오 렌더링

### 렌더링 방식 비교

```
┌─────────────────────────────────────────────────────────────────┐
│                  스테레오 렌더링 방식                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. Multi-Pass (기본)                                           │
│     ┌─────────────────────────────────────────────────────┐    │
│     │                                                      │    │
│     │  Pass 1: Left Eye                                   │    │
│     │  ┌────────────┐                                     │    │
│     │  │ Visibility │→ Draw Calls → Render → Left RT     │    │
│     │  └────────────┘                                     │    │
│     │                                                      │    │
│     │  Pass 2: Right Eye                                  │    │
│     │  ┌────────────┐                                     │    │
│     │  │ Visibility │→ Draw Calls → Render → Right RT    │    │
│     │  └────────────┘                                     │    │
│     │                                                      │    │
│     │  • 가장 호환성 좋음                                  │    │
│     │  • CPU 부하 2배                                      │    │
│     └─────────────────────────────────────────────────────┘    │
│                                                                 │
│  2. Instanced Stereo (PC)                                       │
│     ┌─────────────────────────────────────────────────────┐    │
│     │                                                      │    │
│     │  Single Pass:                                        │    │
│     │  ┌────────────┐     ┌─────────────────────────────┐│    │
│     │  │ Visibility │ ──▶ │ Draw Calls (Instanced ×2)  ││    │
│     │  └────────────┘     └─────────────────────────────┘│    │
│     │                              │                      │    │
│     │                    ┌─────────┴─────────┐           │    │
│     │                    ▼                   ▼           │    │
│     │               Left RT             Right RT         │    │
│     │                                                      │    │
│     │  • GPU 인스턴싱으로 효율적                          │    │
│     │  • Draw Call 1회, 렌더링 2회                        │    │
│     └─────────────────────────────────────────────────────┘    │
│                                                                 │
│  3. Mobile Multi-View (모바일)                                  │
│     ┌─────────────────────────────────────────────────────┐    │
│     │                                                      │    │
│     │  ┌────────────┐     ┌─────────────────────────────┐│    │
│     │  │ Visibility │ ──▶ │ MultiView Extension        ││    │
│     │  └────────────┘     │ (GL_OVR_multiview2)        ││    │
│     │                     └─────────────────────────────┘│    │
│     │                              │                      │    │
│     │                    ┌─────────┴─────────┐           │    │
│     │                    ▼                   ▼           │    │
│     │               Left Eye            Right Eye        │    │
│     │               (Layer 0)           (Layer 1)        │    │
│     │                                                      │    │
│     │  • 하드웨어 레벨 최적화                              │    │
│     │  • Quest 필수                                        │    │
│     └─────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 최적화 기법

### VR 특화 최적화

| 기법 | 설명 | 효과 |
|------|------|------|
| **Fixed Foveated Rendering** | 주변부 해상도 감소 | GPU 30-50% 절약 |
| **Application SpaceWarp** | 프레임 보간 | 45 FPS → 90 FPS 가상 |
| **Late Latching** | 마지막 순간 포즈 업데이트 | 지연 감소 |
| **Hidden Area Mesh** | 렌즈 외곽 렌더링 스킵 | 10-15% 절약 |

### 렌더링 파이프라인

```
┌─────────────────────────────────────────────────────────────────┐
│                    VR 렌더링 파이프라인                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Frame N                                                        │
│       │                                                         │
│       ▼                                                         │
│  ┌─────────────────────────────────────────┐                   │
│  │         Pose Prediction                 │                   │
│  │  • HMD 위치/회전 예측                    │                   │
│  │  • 프레임 표시 시점 기준                  │                   │
│  └────────────────┬────────────────────────┘                   │
│                   │                                             │
│                   ▼                                             │
│  ┌─────────────────────────────────────────┐                   │
│  │         Scene Update                    │                   │
│  │  • 게임 로직                             │                   │
│  │  • 애니메이션                            │                   │
│  └────────────────┬────────────────────────┘                   │
│                   │                                             │
│                   ▼                                             │
│  ┌─────────────────────────────────────────┐                   │
│  │         Stereo Rendering                │                   │
│  │  • Left/Right Eye 렌더링                │                   │
│  │  • FFR 적용                             │                   │
│  └────────────────┬────────────────────────┘                   │
│                   │                                             │
│                   ▼                                             │
│  ┌─────────────────────────────────────────┐                   │
│  │         Late Latching (선택)            │                   │
│  │  • 최신 포즈로 뷰 매트릭스 업데이트       │                   │
│  └────────────────┬────────────────────────┘                   │
│                   │                                             │
│                   ▼                                             │
│  ┌─────────────────────────────────────────┐                   │
│  │         Compositor Submit               │                   │
│  │  • 렌더 타겟 제출                        │                   │
│  │  • 렌즈 왜곡 보정                        │                   │
│  │  • 디스플레이 출력                       │                   │
│  └─────────────────────────────────────────┘                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 문서 구성

| 문서 | 내용 |
|------|------|
| [VR 렌더링 기초](01-vr-basics.md) | VR 렌더링 원리, HMD, 렌즈 왜곡 |
| [스테레오 렌더링](02-stereo-rendering.md) | 스테레오 기법, Instanced Stereo, Multi-View |
| [VR 최적화](03-vr-optimization.md) | FFR, ASW, 지연 최소화 |
| [모션 컨트롤러](04-motion-controllers.md) | 핸드 트래킹, 햅틱, 인터랙션 |
| [AR/MR 렌더링](05-ar-mr-rendering.md) | AR 패스스루, 공간 앵커, 오클루전 |

---

## 성능 목표

### 플랫폼별 타겟

| 항목 | Quest 3 | PC VR | PSVR 2 |
|------|---------|-------|--------|
| **FPS** | 72/90 Hz | 90 Hz | 90/120 Hz |
| **해상도** | 네이티브 | 1.4x 슈퍼샘플링 | 네이티브 |
| **Draw Calls** | < 150 | < 500 | < 300 |
| **삼각형** | < 200K | < 1M | < 500K |
| **지연** | < 20ms | < 15ms | < 15ms |

---

## 프레임워크

```
┌─────────────────────────────────────────────────────────────────┐
│                    UE XR 프레임워크                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Game Code                             │   │
│  │  • Pawn/Character                                        │   │
│  │  • Motion Controller Component                           │   │
│  │  • VR Interaction                                        │   │
│  └────────────────────────────┬────────────────────────────┘   │
│                               │                                 │
│                               ▼                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │               Head Mounted Display (HMD)                 │   │
│  │  • IXRTrackingSystem                                     │   │
│  │  • IHeadMountedDisplay                                   │   │
│  │  • IXRCamera                                             │   │
│  └────────────────────────────┬────────────────────────────┘   │
│                               │                                 │
│                               ▼                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   XR Runtime                             │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │   │
│  │  │ OpenXR  │ │ Oculus  │ │ SteamVR │ │ ARKit/  │        │   │
│  │  │         │ │         │ │         │ │ ARCore  │        │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 참고 자료

- [Unreal Engine XR Development](https://docs.unrealengine.com/xr-development/)
- [OpenXR Specification](https://www.khronos.org/openxr/)
- [Meta Quest Development](https://developer.oculus.com/)
- [SteamVR Documentation](https://developer.valvesoftware.com/wiki/SteamVR)

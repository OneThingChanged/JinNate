# Ch.16 모바일 렌더링

모바일 플랫폼에 최적화된 UE 렌더링 시스템을 분석합니다.

---

## 개요

모바일 렌더링은 제한된 하드웨어 리소스에서 최적의 품질을 달성하기 위한 특수한 접근 방식이 필요합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                  모바일 렌더링 아키텍처                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Rendering Path                        │   │
│  │                                                          │   │
│  │     Desktop (Deferred)          Mobile (Forward)         │   │
│  │     ┌─────────────────┐        ┌─────────────────┐      │   │
│  │     │                 │        │                 │      │   │
│  │     │ • G-Buffer      │        │ • Single Pass   │      │   │
│  │     │ • Multiple Pass │        │ • TBDR 최적화   │      │   │
│  │     │ • High Bandwidth│        │ • Low Bandwidth │      │   │
│  │     │                 │        │                 │      │   │
│  │     └─────────────────┘        └─────────────────┘      │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  모바일 렌더링 특성:                                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                          │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │   │
│  │  │    TBDR     │  │  Low Power   │  │  Limited     │   │   │
│  │  │  GPU 활용   │  │   Design     │  │  Memory      │   │   │
│  │  ├──────────────┤  ├──────────────┤  ├──────────────┤   │   │
│  │  │ • Tile 기반 │  │ • 열 관리    │  │ • 작은 VRAM │   │   │
│  │  │ • On-chip   │  │ • 배터리     │  │ • 공유 메모리│   │   │
│  │  │   Memory    │  │ • Throttling │  │ • 압축 필수  │   │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘   │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 모바일 GPU 아키텍처

### TBDR (Tile-Based Deferred Rendering)

```
┌─────────────────────────────────────────────────────────────────┐
│                     TBDR 파이프라인                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Immediate Mode (Desktop)                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                          │   │
│  │  Vertex → Rasterize → Fragment → Framebuffer            │   │
│  │                           │           │                  │   │
│  │                           └──── 즉시 메모리 R/W ────┘    │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Tile-Based (Mobile)                                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                          │   │
│  │  Phase 1: Geometry Processing                            │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │ Vertex Shader → Tile Binning → Per-Tile Lists   │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                          │                               │   │
│  │                          ▼                               │   │
│  │  Phase 2: Per-Tile Rendering                             │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │  ┌────┐ ┌────┐ ┌────┐ ┌────┐                    │    │   │
│  │  │  │Tile│ │Tile│ │Tile│ │Tile│  ...              │    │   │
│  │  │  │ 0  │ │ 1  │ │ 2  │ │ 3  │                    │    │   │
│  │  │  └──┬─┘ └──┬─┘ └──┬─┘ └──┬─┘                    │    │   │
│  │  │     └──────┴──────┴──────┘                       │    │   │
│  │  │             │                                     │    │   │
│  │  │        On-Chip Memory                            │    │   │
│  │  │      (타일별 독립 처리)                           │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                          │                               │   │
│  │                          ▼                               │   │
│  │  Phase 3: Tile Resolve (메모리 쓰기)                    │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 주요 모바일 GPU

| GPU | 제조사 | 특징 |
|-----|--------|------|
| **Adreno** | Qualcomm | FlexRender, Vulkan 최적화 |
| **Mali** | ARM | Bifrost/Valhall, Tile 기반 |
| **PowerVR** | Imagination | HSR, TBDR 원조 |
| **Apple GPU** | Apple | Metal 최적화, 통합 메모리 |

---

## UE 모바일 렌더러

### 렌더링 경로

```cpp
// 모바일 렌더링 피처 레벨
enum class ERHIFeatureLevel : uint8
{
    ES3_1,    // OpenGL ES 3.1 / Vulkan Mobile
    SM5,      // Desktop
    SM6       // DX12 Ultimate
};

// 모바일 셰이딩 경로
enum class EMobileShadingPath : uint8
{
    Forward,          // 기본 Forward 렌더링
    Deferred,         // Mobile Deferred (제한적)
};

// 모바일 HDR 설정
enum class EMobileHDR : uint8
{
    Disabled,         // LDR
    MosaicHDR,       // HDR Mosaic Encoding
    FloatRGBA,       // FP16 (고사양)
};
```

### 피처 레벨 비교

| 기능 | ES3_1 | SM5 |
|------|-------|-----|
| **Dynamic Shadows** | 제한적 | 전체 |
| **Reflections** | SSR 제한 | 전체 |
| **GI** | 없음/LPV | Lumen |
| **Max Textures** | 16 | 128+ |
| **Compute Shaders** | 제한적 | 전체 |

---

## Forward 렌더링

### 모바일 Forward 특성

```
┌─────────────────────────────────────────────────────────────────┐
│                  Mobile Forward 파이프라인                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Single Pass                           │   │
│  │                                                          │   │
│  │  For each Object:                                        │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │                                                  │    │   │
│  │  │  Vertex Shader                                   │    │   │
│  │  │      │                                           │    │   │
│  │  │      ▼                                           │    │   │
│  │  │  Fragment Shader                                 │    │   │
│  │  │  ┌─────────────────────────────────────────┐    │    │   │
│  │  │  │ • Base Color                            │    │    │   │
│  │  │  │ • Normal Mapping                        │    │    │   │
│  │  │  │ • Lighting (N lights in one pass)       │    │    │   │
│  │  │  │ • Shadow Sampling                       │    │    │   │
│  │  │  │ • Final Color Output                    │    │    │   │
│  │  │  └─────────────────────────────────────────┘    │    │   │
│  │  │      │                                           │    │   │
│  │  │      ▼                                           │    │   │
│  │  │  Framebuffer                                     │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  장점:                          단점:                           │
│  • 낮은 대역폭                  • 라이트 수 제한                 │
│  • TBDR 친화적                 • 복잡한 셰이더                  │
│  • MSAA 지원                   • 반투명 정렬 필요               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 라이트 제한

```cpp
// 모바일 라이트 설정
// Project Settings → Rendering → Mobile

// 최대 동적 라이트 수
int32 MaxDynamicPointLights = 4;

// CSM 캐스케이드 수
int32 MobileCSMMaxCascades = 2;

// 라이트 복잡도 처리
void ProcessMobileLights(FScene* Scene, FViewInfo& View)
{
    // 가장 영향력 있는 라이트만 선택
    TArray<FLightSceneInfo*> RelevantLights;

    for (FLightSceneInfo* Light : Scene->Lights)
    {
        float Importance = CalculateLightImportance(Light, View);

        if (RelevantLights.Num() < MaxDynamicPointLights)
        {
            RelevantLights.Add(Light);
        }
    }

    // 라이트 정보를 유니폼 버퍼로 패킹
    PackLightsToUniformBuffer(RelevantLights);
}
```

---

## 모바일 그림자

### Cascaded Shadow Maps

```
┌─────────────────────────────────────────────────────────────────┐
│                  Mobile CSM 설정                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Desktop CSM (4 캐스케이드)        Mobile CSM (2 캐스케이드)     │
│  ┌─────────────────────┐          ┌─────────────────────┐      │
│  │ ┌───┬───┬───┬───┐  │          │ ┌─────────┬───────┐ │      │
│  │ │ 0 │ 1 │ 2 │ 3 │  │          │ │    0    │   1   │ │      │
│  │ └───┴───┴───┴───┘  │          │ └─────────┴───────┘ │      │
│  │ 2048×2048 × 4      │          │ 1024×1024 × 2      │      │
│  └─────────────────────┘          └─────────────────────┘      │
│                                                                 │
│  모바일 그림자 최적화:                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                          │   │
│  │  1. Modulated Shadows (반투명 그림자)                    │   │
│  │     • 낮은 비용                                          │   │
│  │     • 자체 그림자 없음                                   │   │
│  │                                                          │   │
│  │  2. Distance Field Shadows                              │   │
│  │     • 원거리 그림자 대체                                 │   │
│  │     • 메모리 사용                                        │   │
│  │                                                          │   │
│  │  3. Capsule Shadows                                     │   │
│  │     • 캐릭터 근사 그림자                                 │   │
│  │     • 저비용                                             │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 문서 구성

| 문서 | 내용 |
|------|------|
| [모바일 렌더링 개요](01-mobile-overview.md) | 모바일 GPU, TBDR, 렌더링 경로 |
| [모바일 셰이더](02-mobile-shaders.md) | ES3.1 셰이더, 최적화 기법 |
| [모바일 라이팅](03-mobile-lighting.md) | Forward 라이팅, 그림자, GI |
| [모바일 텍스처](04-mobile-textures.md) | 압축 포맷, 스트리밍, 아틀라스 |
| [모바일 최적화](05-mobile-optimization.md) | 프로파일링, 열 관리, 배터리 |

---

## 성능 타겟

### 플랫폼별 목표

| 항목 | Low-End | Mid-Range | High-End |
|------|---------|-----------|----------|
| **해상도** | 720p | 1080p | 1440p+ |
| **FPS** | 30 | 30-60 | 60 |
| **Draw Calls** | < 200 | < 500 | < 1000 |
| **삼각형** | < 100K | < 300K | < 500K |
| **텍스처 메모리** | < 256MB | < 512MB | < 1GB |

### 최적화 우선순위

```
┌─────────────────────────────────────────────────────────────────┐
│                  모바일 최적화 우선순위                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 대역폭 최소화                                                │
│     ├── 텍스처 압축 (ASTC, ETC2)                               │
│     ├── 렌더 타겟 최소화                                        │
│     └── Tile Memory 활용                                       │
│                                                                 │
│  2. 오버드로우 감소                                              │
│     ├── 적절한 정렬                                             │
│     ├── Early-Z 활용                                           │
│     └── Masked 최소화                                          │
│                                                                 │
│  3. 셰이더 복잡도                                                │
│     ├── Half precision 사용                                    │
│     ├── 텍스처 Fetch 최소화                                    │
│     └── 분기 최소화                                             │
│                                                                 │
│  4. Draw Call 배칭                                              │
│     ├── Static Batching                                        │
│     ├── Instancing                                             │
│     └── 머티리얼 통합                                           │
│                                                                 │
│  5. 열 관리                                                     │
│     ├── 프레임 버짓 준수                                        │
│     ├── Throttling 대응                                        │
│     └── 적응형 품질                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 참고 자료

- [Unreal Engine Mobile 문서](https://docs.unrealengine.com/mobile/)
- [ARM Mali Best Practices](https://developer.arm.com/mali)
- [Qualcomm Adreno Guide](https://developer.qualcomm.com/software/adreno-gpu-sdk)

# 모바일 최적화

모바일 플랫폼의 종합적인 최적화 전략과 프로파일링 기법을 분석합니다.

---

## 성능 프로파일링

### 모바일 프로파일러

```
┌─────────────────────────────────────────────────────────────────┐
│                  모바일 프로파일링 도구                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  UE 내장 도구:                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • Unreal Insights     (범용 프로파일링)                  │   │
│  │ • stat GPU            (GPU 타이밍)                      │   │
│  │ • stat unit           (프레임 타이밍)                    │   │
│  │ • stat scenerendering (렌더링 통계)                     │   │
│  │ • ProfileGPU          (GPU 캡처)                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  벤더 도구:                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Android:                                                 │   │
│  │ • Snapdragon Profiler (Qualcomm)                        │   │
│  │ • ARM Mali Graphics Debugger                            │   │
│  │ • NVIDIA Tegra Tools                                    │   │
│  │ • Android GPU Inspector (AGI)                           │   │
│  │                                                          │   │
│  │ iOS:                                                     │   │
│  │ • Xcode GPU Debugger                                    │   │
│  │ • Instruments                                           │   │
│  │ • Metal System Trace                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 프레임 예산

```
┌─────────────────────────────────────────────────────────────────┐
│                  프레임 예산 분배 (30 FPS)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  총 예산: 33.33ms                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                          │   │
│  │  Game Thread:        8-10ms                             │   │
│  │  ├── Tick           4-5ms                               │   │
│  │  ├── Physics        2-3ms                               │   │
│  │  └── Animation      2-3ms                               │   │
│  │                                                          │   │
│  │  Render Thread:     6-8ms                               │   │
│  │  ├── Visibility     2-3ms                               │   │
│  │  ├── Draw Setup     3-4ms                               │   │
│  │  └── Commands       1-2ms                               │   │
│  │                                                          │   │
│  │  GPU:               15-20ms                             │   │
│  │  ├── Shadows        3-5ms                               │   │
│  │  ├── Base Pass      8-10ms                              │   │
│  │  ├── Translucency   2-3ms                               │   │
│  │  └── Post Process   2-3ms                               │   │
│  │                                                          │   │
│  │  여유:              3-5ms (Throttling 대비)             │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  60 FPS 타겟:                                                    │
│  • 총 예산: 16.67ms                                             │
│  • 각 항목 절반으로 축소                                        │
│  • 더 공격적인 최적화 필요                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Draw Call 최적화

### 배칭 전략

```cpp
// Static Batching
// 빌드 타임에 메시 병합

// 설정: Static Mesh → Advanced → Use Full Precision UVs
// Project Settings → Rendering → Static Batching

// Instancing
// 동일 메시 GPU 인스턴싱

// 설정: Static Mesh Component → Rendering → Instance Count
// HISM (Hierarchical Instanced Static Mesh) 사용

// 예시: 폴리지
void OptimizeFoliage()
{
    // 개별 Static Mesh Actor 대신
    // Instanced Static Mesh 사용

    UHierarchicalInstancedStaticMeshComponent* HISM =
        CreateHISM(FoliageMesh);

    for (const FTransform& Transform : FoliageTransforms)
    {
        HISM->AddInstance(Transform);
    }
    // 1000개 메시 = 1 Draw Call
}
```

### 머티리얼 통합

```
┌─────────────────────────────────────────────────────────────────┐
│                  머티리얼 배칭                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  문제:                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Object 1 (Material A) → Draw Call 1                    │   │
│  │ Object 2 (Material B) → Draw Call 2                    │   │
│  │ Object 3 (Material C) → Draw Call 3                    │   │
│  │ Object 4 (Material A) → Draw Call 4  (같은 머티리얼!)  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  해결 1: 머티리얼 수 최소화                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • 비슷한 머티리얼 통합                                   │   │
│  │ • 파라미터로 변형                                        │   │
│  │ • 텍스처 아틀라스 사용                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  해결 2: 정렬 최적화                                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • 같은 머티리얼 오브젝트 연속 렌더링                     │   │
│  │ • Sort Priority 설정                                    │   │
│  │ • 공간적으로 가까운 오브젝트 같은 머티리얼               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  해결 3: Merge Actors                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Developer → Merge Actors                                │   │
│  │ • 선택한 액터들을 하나로 병합                            │   │
│  │ • LOD 자동 생성 가능                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 오버드로우 감소

### 오버드로우 분석

```
┌─────────────────────────────────────────────────────────────────┐
│                  Overdraw 분석                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  시각화:                                                         │
│  ShowFlag.ShaderComplexity 1                                    │
│  ShowFlag.QuadOverdraw 1                                        │
│                                                                 │
│  색상 의미:                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 녹색   = 1x (좋음)                                      │   │
│  │ 노랑   = 2x (보통)                                      │   │
│  │ 주황   = 3-4x (주의)                                    │   │
│  │ 빨강   = 5x+ (문제)                                     │   │
│  │ 흰색   = 10x+ (심각)                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  주요 원인:                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • 반투명 파티클                                          │   │
│  │ • 겹치는 UI 요소                                         │   │
│  │ • 대형 반투명 메시                                       │   │
│  │ • Masked 머티리얼                                       │   │
│  │ • 여러 레이어의 데칼                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 최적화 기법

```cpp
// 1. 파티클 최적화
// Niagara/Cascade → Overdraw 제한
MaxDrawCount = 100;           // 파티클 수 제한
SortMode = ByDistance;        // 정렬로 블렌딩 최적화
CutoutTexture = true;         // 알파 컷아웃

// 2. 반투명 정렬
// 뒤에서 앞 순서로 렌더링
Component->SetTranslucentSortPriority(Priority);

// 3. 오파시티 마스크 대신 디더링
// Masked → Dithered Opacity
// discard 대신 디더 패턴 사용
half DitherMask = InterleavedGradientNoise(ScreenUV, FrameNumber);
clip(Opacity - DitherMask);

// 4. Render Bounds 최적화
// 불필요하게 큰 바운드 축소
Mesh->SetBounds(OptimizedBounds);
```

---

## 열 관리 (Thermal)

### Throttling 대응

```
┌─────────────────────────────────────────────────────────────────┐
│                  열 관리 전략                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  열 상태 모니터링:                                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                          │   │
│  │  정상        경고         Throttling      위험          │   │
│  │  │           │            │               │             │   │
│  │  ▼           ▼            ▼               ▼             │   │
│  │  ├───────────┼────────────┼───────────────┼──────────▶  │   │
│  │  30°C       40°C         45°C            50°C    온도   │   │
│  │                                                          │   │
│  │  100%        90%          70%             50%    성능   │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  적응형 품질 시스템:                                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                          │   │
│  │  void UpdateAdaptiveQuality()                           │   │
│  │  {                                                       │   │
│  │      float ThermalState = GetThermalState();            │   │
│  │      float FrameTime = GetAverageFrameTime();           │   │
│  │                                                          │   │
│  │      if (ThermalState > 0.8 || FrameTime > TargetFrame) │   │
│  │      {                                                   │   │
│  │          // 품질 낮춤                                    │   │
│  │          LowerQualitySettings();                        │   │
│  │          LowerResolutionScale();                        │   │
│  │      }                                                   │   │
│  │      else if (ThermalState < 0.5 && FrameTime < Target) │   │
│  │      {                                                   │   │
│  │          // 품질 높임                                    │   │
│  │          RaiseQualitySettings();                        │   │
│  │      }                                                   │   │
│  │  }                                                       │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 동적 해상도

```cpp
// Dynamic Resolution
// 프레임 타임 기반 해상도 조정

// 설정
r.DynamicRes.OperationMode=2        // 2=Auto
r.DynamicRes.MinScreenPercentage=50 // 최소 50%
r.DynamicRes.MaxScreenPercentage=100 // 최대 100%
r.DynamicRes.TargetedGPUHeadRoom=20  // 20% 여유

// 코드 예시
void SetupDynamicResolution()
{
    GEngine->DynamicResolutionState = EDynamicResolutionStatus::Enabled;

    // 콜백 설정
    FDynamicResolutionHeuristicProxy::GetDelegate().BindLambda(
        [](float& ScreenPercentage)
        {
            float FrameTime = FPlatformTime::GetSecondsPerCycle() *
                             GGameThreadTime;

            if (FrameTime > TargetFrameTime * 1.1f)
            {
                ScreenPercentage *= 0.95f;  // 5% 감소
            }
            else if (FrameTime < TargetFrameTime * 0.9f)
            {
                ScreenPercentage *= 1.05f;  // 5% 증가
            }

            ScreenPercentage = FMath::Clamp(ScreenPercentage, 50.0f, 100.0f);
        });
}
```

---

## 메모리 최적화

### 메모리 예산

```
┌─────────────────────────────────────────────────────────────────┐
│                  모바일 메모리 예산 (2GB 디바이스)               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  시스템 예약:         ~800MB                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │████████████████████████████████████████░░░░░░░░░░░░░░░░│   │
│  │           OS + 앱            사용 가능                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  게임 예산:           ~1.2GB                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                          │   │
│  │  텍스처:        400-500MB                               │   │
│  │  메시:          200-300MB                               │   │
│  │  오디오:        50-100MB                                │   │
│  │  애니메이션:    50-100MB                                │   │
│  │  레벨 데이터:   100-150MB                               │   │
│  │  렌더 타겟:     100-150MB                               │   │
│  │  기타:          100-200MB                               │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  모니터링:                                                       │
│  stat memory                                                    │
│  stat memoryplatform                                            │
│  memreport -full                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 메모리 절약 기법

```cpp
// 1. 에셋 스트리밍
r.Streaming.PoolSize=256              // 스트리밍 풀 제한
r.Streaming.Boost=0                   // 부스트 비활성화

// 2. 저해상도 에셋
// 플랫폼별 쿠킹
[Android_Low]
+CVars=r.Streaming.MipBias=2          // 2단계 낮은 밉

// 3. 메시 LOD
Mesh->SetForcedLOD(MinLOD);           // 최소 LOD 강제

// 4. 렌더 타겟 최적화
// HDR 포맷 주의
r.Mobile.HDR=0                        // LDR 사용
r.Mobile.HDR32bpp=0                   // 16bpp

// 5. 셰이더 메모리
r.ShaderPipelineCache.Enabled=1       // 파이프라인 캐시
r.ShaderCodeLibrary.Enable=1          // 셰이더 라이브러리

// 6. GC 최적화
gc.TimeBetweenPurgingPendingKillObjects=30
gc.MaxObjectsNotConsideredByGC=1
```

---

## 배터리 최적화

### 전력 소비 요인

```
┌─────────────────────────────────────────────────────────────────┐
│                  전력 소비 요인                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  GPU (가장 큰 소비):                                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • 셰이더 복잡도                                          │   │
│  │ • 텍스처 샘플링                                          │   │
│  │ • 필레이트                                               │   │
│  │ • 대역폭 사용                                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  CPU:                                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • 게임 로직                                              │   │
│  │ • 물리 시뮬레이션                                        │   │
│  │ • Draw Call 준비                                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  기타:                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • 화면 밝기                                              │   │
│  │ • 네트워크                                               │   │
│  │ • 오디오                                                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  최적화 전략:                                                    │
│  • 30 FPS 타겟 (60 FPS 대비 전력 절약)                         │
│  • 낮은 해상도                                                  │
│  • 간소화된 셰이더                                              │
│  • 스로틀링 전 선제 대응                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 체크리스트

### 릴리즈 전 체크리스트

```
┌─────────────────────────────────────────────────────────────────┐
│                  모바일 최적화 체크리스트                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  렌더링                                                          │
│  □ Draw Call < 300 (Low-End), < 500 (High-End)                 │
│  □ 삼각형 < 300K (30 FPS), < 150K (60 FPS)                     │
│  □ Overdraw < 3x 평균                                           │
│  □ MSAA 2x 또는 비활성화 (저사양)                               │
│                                                                 │
│  텍스처                                                          │
│  □ ASTC 압축 사용                                               │
│  □ 최대 해상도 1024 (캐릭터), 512 (환경)                        │
│  □ 스트리밍 풀 256-512MB                                        │
│  □ 밉맵 적절히 생성                                             │
│                                                                 │
│  셰이더                                                          │
│  □ half precision 사용                                          │
│  □ 텍스처 Fetch 최소화                                          │
│  □ 분기 최소화                                                  │
│  □ 배리언트 정리                                                │
│                                                                 │
│  메모리                                                          │
│  □ 총 사용량 < 1GB (2GB 디바이스 기준)                          │
│  □ 렌더 타겟 최적화                                             │
│  □ 에셋 스트리밍 활성화                                         │
│                                                                 │
│  성능                                                            │
│  □ 프레임 타임 안정적 (스파이크 없음)                           │
│  □ 30분 플레이 후 열 안정                                       │
│  □ 동적 해상도 테스트                                           │
│  □ 저사양 디바이스 테스트                                       │
│                                                                 │
│  빌드                                                            │
│  □ Shipping 빌드 테스트                                         │
│  □ APK/IPA 크기 확인                                            │
│  □ 쿠킹 설정 최적화                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 참고 자료

- [Unreal Engine Mobile Performance Guidelines](https://docs.unrealengine.com/mobile-performance/)
- [ARM Mali Best Practices](https://developer.arm.com/documentation/)
- [Apple Metal Best Practices](https://developer.apple.com/metal/)
- [Qualcomm Adreno Optimization](https://developer.qualcomm.com/)

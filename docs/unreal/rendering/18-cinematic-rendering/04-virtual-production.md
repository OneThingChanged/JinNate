# 버추얼 프로덕션

LED Wall과 In-Camera VFX를 위한 버추얼 프로덕션 렌더링을 분석합니다.

---

## 버추얼 프로덕션 개요

### In-Camera VFX

```
┌─────────────────────────────────────────────────────────────────┐
│                  In-Camera VFX 구조                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    LED Volume Stage                      │   │
│  │                                                          │   │
│  │         LED Wall (배경)                                  │   │
│  │     ╔═══════════════════════════════════╗               │   │
│  │     ║                                   ║               │   │
│  │     ║     ┌─────────────────────┐      ║               │   │
│  │     ║     │                     │      ║               │   │
│  │     ║     │    가상 환경        │      ║               │   │
│  │     ║     │    (UE 렌더링)      │      ║               │   │
│  │     ║     │                     │      ║               │   │
│  │     ║     └─────────────────────┘      ║               │   │
│  │     ║                                   ║               │   │
│  │     ╚═══════════════════════════════════╝               │   │
│  │                      │                                   │   │
│  │         ┌────────────┼────────────┐                     │   │
│  │         │   실제     │   카메라   │                     │   │
│  │         │   배우/세트│   ◎       │                     │   │
│  │         └────────────┴────────────┘                     │   │
│  │                                                          │   │
│  │  특징:                                                    │   │
│  │  • 실시간 배경 렌더링                                    │   │
│  │  • 자연스러운 조명 반사                                  │   │
│  │  • 그린스크린 불필요                                     │   │
│  │  • 카메라 시점에 맞춘 원근                               │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## nDisplay

### 클러스터 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                  nDisplay 클러스터 구조                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Primary Node                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │ • 게임 로직 실행                                  │    │   │
│  │  │ • 입력 처리                                       │    │   │
│  │  │ • 씬 동기화                                       │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  └────────────────────────────┬────────────────────────────┘   │
│                               │                                 │
│              ┌────────────────┼────────────────┐               │
│              │                │                │               │
│              ▼                ▼                ▼               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Render Node 1│  │ Render Node 2│  │ Render Node 3│  ...    │
│  │              │  │              │  │              │         │
│  │  GPU 1       │  │  GPU 2       │  │  GPU 3       │         │
│  │  Viewport A  │  │  Viewport B  │  │  Viewport C  │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│         │                 │                 │                  │
│         ▼                 ▼                 ▼                  │
│  ┌──────────────────────────────────────────────────────┐     │
│  │              LED Wall Segments                        │     │
│  │  ┌────────┐  ┌────────┐  ┌────────┐                  │     │
│  │  │ Panel  │  │ Panel  │  │ Panel  │  ...            │     │
│  │  │   1    │  │   2    │  │   3    │                  │     │
│  │  └────────┘  └────────┘  └────────┘                  │     │
│  └──────────────────────────────────────────────────────┘     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### nDisplay 설정

```cpp
// nDisplay Config 파일 (.ndisplay)
{
    "nDisplay": {
        "version": "5.0",
        "description": "LED Volume Setup",

        "cluster": {
            "primaryNode": {
                "id": "node_primary",
                "host": "192.168.1.100",
                "ports": {
                    "ClusterSync": 41000,
                    "ClusterEvents": 41001,
                    "ClusterEventsBinary": 41002
                }
            },
            "nodes": [
                {
                    "id": "node_render_1",
                    "host": "192.168.1.101",
                    "window": {
                        "id": "wnd_1",
                        "viewports": ["vp_left"]
                    }
                },
                {
                    "id": "node_render_2",
                    "host": "192.168.1.102",
                    "window": {
                        "id": "wnd_2",
                        "viewports": ["vp_center"]
                    }
                }
            ]
        },

        "viewports": [
            {
                "id": "vp_left",
                "region": { "x": 0, "y": 0, "w": 1920, "h": 1080 },
                "camera": "cam_main",
                "projection": "proj_simple"
            }
        ]
    }
}
```

---

## Inner Frustum

### 카메라 프러스텀

```
┌─────────────────────────────────────────────────────────────────┐
│                  Inner Frustum 렌더링                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    LED Wall View                         │   │
│  │                                                          │   │
│  │    ┌───────────────────────────────────────────────┐    │   │
│  │    │                                               │    │   │
│  │    │          Outer Frustum                        │    │   │
│  │    │      (주변 영역 - 저해상도)                    │    │   │
│  │    │                                               │    │   │
│  │    │    ┌─────────────────────────────┐            │    │   │
│  │    │    │                             │            │    │   │
│  │    │    │     Inner Frustum           │            │    │   │
│  │    │    │   (카메라 시야 - 고해상도)   │            │    │   │
│  │    │    │                             │            │    │   │
│  │    │    │         ◎ Camera            │            │    │   │
│  │    │    │                             │            │    │   │
│  │    │    └─────────────────────────────┘            │    │   │
│  │    │                                               │    │   │
│  │    └───────────────────────────────────────────────┘    │   │
│  │                                                          │   │
│  │  Inner Frustum 특성:                                      │   │
│  │  • 카메라 FOV에 맞춤                                      │   │
│  │  • 정확한 원근 보정                                       │   │
│  │  • 고해상도 렌더링                                        │   │
│  │  • 실시간 카메라 트래킹                                   │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Inner Frustum 설정

```cpp
// Inner Frustum 컴포넌트
UPROPERTY(EditAnywhere, Category = "ICVFX")
class UDisplayClusterICVFXCameraComponent : public USceneComponent
{
    // 카메라 참조
    ACineCameraActor* CameraRef;

    // 버퍼 비율
    float BufferRatio = 1.0f;  // 오버스캔

    // 소프트 엣지
    float SoftEdge = 0.1f;

    // 크로마 키
    bool bEnableChromaKey = false;
    FLinearColor ChromaKeyColor;

    // 라이트 카드 오버랩
    bool bAllowInnerFrustumLightCards = true;
};

// 카메라 트래킹 설정
UPROPERTY(EditAnywhere)
struct FTrackingSettings
{
    // 트래킹 시스템
    ETrackingSystem TrackingSystem = ETrackingSystem::LiveLink;

    // 지연 보정
    float LatencyOffset = 0.0f;  // 프레임

    // 스무딩
    float SmoothingFactor = 0.0f;
};
```

---

## Live Link

### 실시간 데이터 스트리밍

```
┌─────────────────────────────────────────────────────────────────┐
│                  Live Link 데이터 플로우                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  외부 소스                         UE                           │
│  ┌──────────────┐                ┌──────────────┐              │
│  │ 카메라 트래커│ ──────────────▶│              │              │
│  │ (VICON,      │   위치/회전    │   Live Link  │              │
│  │  OptiTrack)  │                │    Client    │              │
│  └──────────────┘                │              │              │
│                                  │      ▼       │              │
│  ┌──────────────┐                │  ┌────────┐  │              │
│  │ 페이스 캡처  │ ──────────────▶│  │ 블렌드 │  │              │
│  │ (iPhone,    │   얼굴 데이터   │  │ 쉐이프 │  │              │
│  │  ARKit)     │                │  └────────┘  │              │
│  └──────────────┘                │      ▼       │              │
│                                  │  ┌────────┐  │              │
│  ┌──────────────┐                │  │ 카메라 │  │              │
│  │ 모캡 슈트   │ ──────────────▶│  │ 본     │  │              │
│  │ (Xsens,     │   스켈레톤     │  └────────┘  │              │
│  │  Rokoko)    │                │              │              │
│  └──────────────┘                └──────────────┘              │
│                                                                 │
│  지원 프로토콜:                                                  │
│  • FreeD (카메라 트래킹)                                        │
│  • OSC (Open Sound Control)                                    │
│  • VRPN (VR Peripheral Network)                                │
│  • Custom UDP/TCP                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Live Link 설정

```cpp
// Live Link 소스 등록
void SetupLiveLink()
{
    FLiveLinkClient& Client = IModularFeatures::Get()
        .GetModularFeature<FLiveLinkClient>(FLiveLinkClient::ModularFeatureName);

    // FreeD 카메라 소스
    FLiveLinkSourcePreset FreeDPreset;
    FreeDPreset.SourceType = ULiveLinkFreeDSource::StaticClass();
    FreeDPreset.Settings.Port = 6000;

    Client.AddSource(FreeDPreset);

    // 서브젝트 매핑
    FLiveLinkSubjectKey CameraSubject("CameraTracker", "MainCamera");

    // 블루프린트에서 사용
    // Get Live Link Subject Representation
    // Apply Live Link Transform
}

// 지연 보정
UPROPERTY(EditAnywhere)
FTimecode FrameDelay;  // 프레임 단위 지연 보정
```

---

## 색 보정

### LED Wall 캘리브레이션

```
┌─────────────────────────────────────────────────────────────────┐
│                  LED Wall 색 보정                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  OpenColorIO (OCIO) 파이프라인:                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                          │   │
│  │  UE 렌더링 → ACES → ODT (Output Display Transform)     │   │
│  │      │          │           │                           │   │
│  │      │          │           ▼                           │   │
│  │      │          │    ┌─────────────┐                   │   │
│  │      │          │    │ LED Wall   │                   │   │
│  │      │          └───▶│ Color Space │                   │   │
│  │      │               └─────────────┘                   │   │
│  │      │                                                  │   │
│  │      ▼                                                  │   │
│  │  Scene Linear ──▶ View Transform ──▶ Display           │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  LED 패널 보정:                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                          │   │
│  │  1. 화이트 밸런스 조정                                   │   │
│  │  2. 감마 보정                                            │   │
│  │  3. 색역 매핑 (LED 색역 → 카메라 색역)                  │   │
│  │  4. 균일도 보정 (밝기 편차)                              │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### OCIO 설정

```cpp
// OCIO 설정
UPROPERTY(EditAnywhere, Category = "Color")
struct FOCIOSettings
{
    // OCIO 컨피그 경로
    FFilePath OCIOConfigPath = TEXT("/Game/OCIO/aces_1.2/config.ocio");

    // 작업 색공간
    FString WorkingColorSpace = TEXT("ACES - ACEScg");

    // 출력 변환
    FString OutputColorSpace = TEXT("Output - Rec.709");

    // LED Wall 전용 변환
    FString LEDDisplayTransform = TEXT("LED - P3-D65");
};

// 콘솔 설정
r.OCIO.Enabled=1
r.OCIO.ConfigPath="/Game/OCIO/config.ocio"
r.OCIO.DisplayColorSpace="LED_Wall"
```

---

## 성능 최적화

### VP 렌더링 최적화

```
┌─────────────────────────────────────────────────────────────────┐
│                  버추얼 프로덕션 최적화                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  렌더링 최적화:                                                  │
│  □ Inner/Outer Frustum 해상도 분리                              │
│  □ LOD 적절히 설정                                              │
│  □ Nanite 활용 (고폴리 에셋)                                   │
│  □ 불필요한 포스트 프로세스 비활성화                            │
│                                                                 │
│  동기화 최적화:                                                  │
│  □ Genlock 설정 (모든 노드 동기)                                │
│  □ Framelock 활성화                                             │
│  □ 네트워크 지연 최소화                                         │
│                                                                 │
│  LED Wall 최적화:                                               │
│  □ 적절한 밝기 설정 (눈부심 방지)                               │
│  □ 리프레시 레이트 매칭                                         │
│  □ 모아레 방지 설정                                             │
│                                                                 │
│  하드웨어 권장:                                                  │
│  • GPU: RTX 4090 또는 A6000 (노드당)                           │
│  • 네트워크: 10Gbps 이상                                        │
│  • Genlock 카드 (NVIDIA Quadro Sync)                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 다음 단계

- [오프라인 렌더링](05-offline-rendering.md)에서 배치 렌더링과 컴포지팅을 학습합니다.

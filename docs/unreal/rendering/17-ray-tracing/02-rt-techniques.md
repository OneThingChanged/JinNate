# RT 기법

BVH와 가속 구조를 설명합니다.

---

## 가속 구조의 필요성

```
┌─────────────────────────────────────────────────────────────────┐
│                    가속 구조 필요성                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  단순 방식: O(N) - 모든 삼각형 테스트                           │
│  • 100만 삼각형 × 100만 광선 = 1조 번 테스트                   │
│  • 불가능!                                                      │
│                                                                 │
│  가속 구조 사용: O(log N)                                       │
│  • BVH로 공간 분할                                             │
│  • 대부분의 삼각형 건너뛰기                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## BVH (Bounding Volume Hierarchy)

```
┌─────────────────────────────────────────────────────────────────┐
│                    BVH 구조                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                    ┌───────────────┐                           │
│                    │   Root AABB   │                           │
│                    │  (전체 씬)    │                           │
│                    └───────┬───────┘                           │
│                            │                                    │
│              ┌─────────────┴─────────────┐                     │
│              ▼                           ▼                     │
│       ┌───────────┐               ┌───────────┐               │
│       │  Left AABB │               │ Right AABB│               │
│       └─────┬─────┘               └─────┬─────┘               │
│             │                           │                      │
│       ┌─────┴─────┐               ┌─────┴─────┐               │
│       ▼           ▼               ▼           ▼               │
│    ┌─────┐    ┌─────┐         ┌─────┐    ┌─────┐             │
│    │Leaf │    │Leaf │         │Leaf │    │Leaf │             │
│    │ △△  │    │ △   │         │ △△△ │    │ △   │             │
│    └─────┘    └─────┘         └─────┘    └─────┘             │
│                                                                 │
│  AABB: Axis-Aligned Bounding Box                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Two-Level AS (TLAS/BLAS)

게임에서 사용되는 2단계 가속 구조입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    Two-Level 가속 구조                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  TLAS (Top-Level AS): 인스턴스 레벨                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │     ┌─────────┐  ┌─────────┐  ┌─────────┐             │   │
│  │     │ Inst 0  │  │ Inst 1  │  │ Inst 2  │  ...       │   │
│  │     │Transform│  │Transform│  │Transform│             │   │
│  │     └────┬────┘  └────┬────┘  └────┬────┘             │   │
│  │          │            │            │                   │   │
│  └──────────┼────────────┼────────────┼───────────────────┘   │
│             │            │            │                        │
│             ▼            ▼            ▼                        │
│  BLAS (Bottom-Level AS): 지오메트리 레벨                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │     ┌─────────┐  ┌─────────┐  ┌─────────┐             │   │
│  │     │ BLAS 0  │  │ BLAS 0  │  │ BLAS 1  │             │   │
│  │     │  (Car)  │  │  (Car)  │  │ (Tree)  │             │   │
│  │     │ (재사용)│  │ (재사용)│  │         │             │   │
│  │     └─────────┘  └─────────┘  └─────────┘             │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  장점:                                                          │
│  • BLAS 재사용 (동일 메시 인스턴싱)                            │
│  • TLAS만 업데이트 (Transform 변경 시)                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## BVH 순회

```cpp
// BVH 순회 의사 코드
bool TraverseBVH(Ray ray, BVHNode* root, HitInfo& hit)
{
    Stack<BVHNode*> stack;
    stack.push(root);

    while (!stack.empty())
    {
        BVHNode* node = stack.pop();

        // AABB 테스트
        if (!RayAABBIntersect(ray, node->bounds))
            continue;

        if (node->IsLeaf())
        {
            // 리프 노드: 삼각형 테스트
            for (Triangle& tri : node->triangles)
            {
                if (RayTriangleIntersect(ray, tri, hit))
                    ray.tMax = hit.t;  // 더 가까운 것만 찾기
            }
        }
        else
        {
            // 내부 노드: 자식 탐색
            stack.push(node->right);
            stack.push(node->left);
        }
    }
    return hit.valid;
}
```

---

## 다음 단계

[RT 응용](03-rt-applications.md)에서 섀도우, AO, 반사를 알아봅니다.

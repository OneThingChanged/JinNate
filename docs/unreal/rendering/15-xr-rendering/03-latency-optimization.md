# 지연시간 최적화

Timewarp, ATW, ASW 등 지연시간 보상 기술을 설명합니다.

---

## Motion-to-Photon 지연

```
┌─────────────────────────────────────────────────────────────────┐
│                    Motion-to-Photon 파이프라인                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  사용자 움직임 → 센서 감지 → 데이터 전송 → 렌더링 → 표시      │
│                                                                 │
│  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐       │
│  │ 머리│→│센서 │→│ USB │→│ CPU │→│ GPU │→│디스플│       │
│  │움직임│  │ 샘플│  │전송 │  │처리 │  │렌더 │  │레이 │       │
│  └─────┘  └─────┘  └─────┘  └─────┘  └─────┘  └─────┘       │
│    0ms     2ms      3ms      5ms     11ms     16ms            │
│                                                                 │
│  목표: 총 지연 < 20ms (이상적)                                  │
│  한계: 60ms 초과 시 멀미 유발                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Timewarp (TW)

완성된 프레임을 머리 회전에 맞게 기하학적으로 워프합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    Timewarp 동작                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  렌더링 시작 시점:              표시 시점:                      │
│  머리 방향 = 0°                 머리 방향 = 5°                  │
│                                                                 │
│  ┌─────────────┐               ┌─────────────┐                 │
│  │             │               │    ╱╱╱╱╱╱   │                 │
│  │   원본      │  → Warp →    │   ╱╱╱╱╱╱    │                 │
│  │   프레임    │               │  ╱╱╱╱╱╱     │                 │
│  │             │               │ (5° 보정됨)  │                 │
│  └─────────────┘               └─────────────┘                 │
│                                                                 │
│  수식:                                                          │
│  newUV = project(rotate(unproject(oldUV), deltaRotation))      │
│                                                                 │
│  장점:                                                          │
│  • 실제 프레임률 유지하면서 지연 보상                          │
│  • 회전 움직임에 효과적                                        │
│                                                                 │
│  한계:                                                          │
│  • 이동(Translation)에는 효과 제한적                           │
│  • 가장자리 아티팩트                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## ATW (Asynchronous Timewarp)

GPU 컨텍스트 선점을 통해 비동기로 Timewarp를 수행합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    ATW 동작                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  GPU 타임라인:                                                  │
│                                                                 │
│  ─────┬──────────────────┬──────────────────┬─────             │
│       │   프레임 N 렌더   │   프레임 N+1     │                  │
│  ─────┴────────┬─────────┴──────────────────┴─────             │
│                │                                                │
│           VSync│  ATW 선점!                                    │
│                ▼  ┌─────┐                                      │
│  ──────────────│──│ ATW │──────────────────────               │
│                   └─────┘                                      │
│                      │                                          │
│                      ▼                                          │
│               최신 머리 방향으로                                │
│               프레임 워프                                       │
│                                                                 │
│  프레임 드롭 시:                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  프레임 N이 VSync까지 완료 안됨                         │   │
│  │  → ATW가 이전 프레임 N-1을 워프하여 표시                │   │
│  │  → 프레임 드롭이 덜 느껴짐                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## ASW (Asynchronous Spacewarp)

프레임 드롭 시 모션 보간으로 중간 프레임을 생성합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    ASW 동작                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  타겟: 90fps → 실제: 45fps → 보간: 90fps                       │
│                                                                 │
│  시간 →                                                         │
│  ┌─────┐         ┌─────┐         ┌─────┐                       │
│  │ F1  │         │ F2  │         │ F3  │   렌더된 프레임      │
│  └─────┘         └─────┘         └─────┘                       │
│      │     ●         │     ●         │                         │
│      │     │         │     │         │                         │
│      │  ┌──┴──┐      │  ┌──┴──┐      │                         │
│      │  │ASW  │      │  │ASW  │      │   보간된 프레임        │
│      │  │ F1' │      │  │ F2' │      │                         │
│      │  └─────┘      │  └─────┘      │                         │
│      ▼     ▼         ▼     ▼         ▼                         │
│     출력  출력      출력  출력      출력                        │
│                                                                 │
│  모션 벡터 기반:                                                │
│  • 이전 프레임과 현재 프레임의 차이 계산                       │
│  • 모션 벡터로 중간 프레임 외삽                                │
│  • 오클루전 영역 처리 필요                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 기술 비교

| 기술 | 보정 대상 | 프레임 생성 | 아티팩트 |
|------|----------|------------|----------|
| **TW** | 회전 지연 | 없음 | 가장자리 |
| **ATW** | 회전 지연 | 이전 프레임 재사용 | 가장자리 |
| **ASW** | 회전+이동 | 보간 프레임 | 오클루전 |
| **PTW** | 회전+이동 | 깊이 기반 워프 | 최소 |

---

## Late Latching

최대한 늦게 센서 데이터를 쿼리하여 지연을 최소화합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    Late Latching                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  기존 방식:                                                     │
│  센서 쿼리 ──── CPU 처리 ──── GPU 렌더 ──── 표시               │
│      │                                       │                  │
│      └───────── 긴 지연 ─────────────────────┘                  │
│                                                                 │
│  Late Latching:                                                 │
│  CPU 처리 ──── GPU 렌더 시작 ──── 센서 쿼리 ──── 표시          │
│                                      │            │             │
│                                      └── 짧은 지연──┘            │
│                                                                 │
│  구현:                                                          │
│  • 렌더링 파이프라인 후반에 뷰 행렬 업데이트                   │
│  • GPU에서 최종 변환 적용                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 다음 단계

[광학 보정](04-optical-correction.md)에서 렌즈 왜곡 보정을 알아봅니다.

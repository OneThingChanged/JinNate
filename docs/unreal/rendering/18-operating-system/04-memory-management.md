# 메모리 관리

가상 메모리, 페이지 테이블, 메모리 매핑을 설명합니다.

---

## 메모리 계층

```
┌─────────────────────────────────────────────────────────────────┐
│                    메모리 계층 구조                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│        속도              용량              비용                 │
│          ↑                 ↓                 ↑                  │
│                                                                 │
│  ┌─────────────┐                                               │
│  │  Registers  │  < 1KB      ~0.5ns                            │
│  └──────┬──────┘                                               │
│         │                                                       │
│  ┌──────▼──────┐                                               │
│  │   L1 Cache  │  32-64KB    ~1ns                              │
│  └──────┬──────┘                                               │
│         │                                                       │
│  ┌──────▼──────┐                                               │
│  │   L2 Cache  │  256KB-1MB  ~4ns                              │
│  └──────┬──────┘                                               │
│         │                                                       │
│  ┌──────▼──────┐                                               │
│  │   L3 Cache  │  4-64MB     ~15ns                             │
│  └──────┬──────┘                                               │
│         │                                                       │
│  ┌──────▼──────┐                                               │
│  │  Main RAM   │  8-128GB    ~100ns                            │
│  └──────┬──────┘                                               │
│         │                                                       │
│  ┌──────▼──────┐                                               │
│  │  SSD/HDD    │  TB급       ~10,000ns (SSD)                   │
│  └─────────────┘             ~10,000,000ns (HDD)               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 가상 메모리

```
┌─────────────────────────────────────────────────────────────────┐
│                    Virtual Memory                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Process A                         Process B                    │
│  ┌─────────────┐                   ┌─────────────┐             │
│  │ Virtual     │                   │ Virtual     │             │
│  │ Address     │                   │ Address     │             │
│  │ Space       │                   │ Space       │             │
│  │             │                   │             │             │
│  │ 0x00000000  │                   │ 0x00000000  │             │
│  │ ~ 0xFFFFFFFF│                   │ ~ 0xFFFFFFFF│             │
│  │             │                   │             │             │
│  │ (4GB each)  │                   │ (4GB each)  │             │
│  └──────┬──────┘                   └──────┬──────┘             │
│         │                                 │                     │
│         │         Page Table              │                     │
│         │     ┌──────────────┐           │                     │
│         └────►│ VA → PA 변환 │◄──────────┘                     │
│               └──────┬───────┘                                  │
│                      │                                          │
│                      ▼                                          │
│         ┌─────────────────────────┐                            │
│         │    Physical Memory      │                            │
│         │                         │                            │
│         │  ┌─────┐ ┌─────┐ ...   │                            │
│         │  │Page │ │Page │        │                            │
│         │  │ A   │ │ B   │        │                            │
│         │  └─────┘ └─────┘        │                            │
│         └─────────────────────────┘                            │
│                                                                 │
│  장점:                                                          │
│  • 프로세스 격리 (다른 프로세스 메모리 접근 불가)              │
│  • 물리 메모리보다 큰 주소 공간                                │
│  • 메모리 공유 가능 (Shared Libraries)                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 페이지 테이블

```
┌─────────────────────────────────────────────────────────────────┐
│                    Page Table 구조                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Virtual Address (32-bit):                                     │
│  ┌──────────────────────┬───────────────┐                     │
│  │ Page Number (20-bit) │ Offset (12-bit)│                     │
│  └──────────┬───────────┴───────┬───────┘                     │
│             │                   │                               │
│             │                   │                               │
│             ▼                   │                               │
│  ┌─────────────────┐           │                               │
│  │   Page Table    │           │                               │
│  │  ┌───────────┐  │           │                               │
│  │  │ PTE 0     │  │           │                               │
│  │  ├───────────┤  │           │                               │
│  │  │ PTE 1     │  │           │                               │
│  │  ├───────────┤  │           │                               │
│  │  │    ...    │  │           │                               │
│  │  ├───────────┤  │           │                               │
│  │  │ PTE N ────┼──┼───► Frame Number                         │
│  │  └───────────┘  │              │                            │
│  └─────────────────┘              │                            │
│                                   │                            │
│  Physical Address:                │                            │
│  ┌────────────────────┬──────────▼──┐                         │
│  │  Frame Number      │    Offset    │                         │
│  └────────────────────┴─────────────┘                         │
│                                                                 │
│  Page Table Entry (PTE):                                       │
│  ┌─────┬─────┬─────┬─────┬───────────────────┐               │
│  │Valid│R/W  │User │Dirty│  Frame Number     │               │
│  │ 1b  │ 1b  │ 1b  │ 1b  │     20-bit        │               │
│  └─────┴─────┴─────┴─────┴───────────────────┘               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## TLB (Translation Lookaside Buffer)

```
┌─────────────────────────────────────────────────────────────────┐
│                    TLB 캐싱                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Virtual Address                                                │
│        │                                                        │
│        ▼                                                        │
│  ┌─────────────┐                                               │
│  │    TLB      │  ← 최근 변환 결과 캐시 (64-1024 entries)      │
│  │             │                                                │
│  │  VA │ PA    │                                               │
│  │ ────┼──── │                                                │
│  │ 0x1 │ 0xA  │                                                │
│  │ 0x3 │ 0xF  │                                                │
│  └──┬──────┬──┘                                                │
│     │      │                                                    │
│     │ Hit  │ Miss                                              │
│     │ (1ns)│ (~100ns)                                          │
│     ▼      ▼                                                    │
│  Physical  Page Table                                           │
│  Address   Lookup                                               │
│                                                                 │
│  TLB Hit Rate가 성능에 매우 중요                               │
│  • 95% Hit Rate: 평균 ~6ns                                     │
│  • 99% Hit Rate: 평균 ~2ns                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Page Fault

```
┌─────────────────────────────────────────────────────────────────┐
│                    Page Fault 처리                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 메모리 접근                                                 │
│        │                                                        │
│        ▼                                                        │
│  2. Page Table 확인 (Valid bit = 0)                            │
│        │                                                        │
│        ▼                                                        │
│  3. Page Fault 발생! (인터럽트)                                │
│        │                                                        │
│        ▼                                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Page Fault Handler (Kernel)                              │   │
│  │                                                         │   │
│  │ a. 유효한 접근인지 확인                                 │   │
│  │    - 아니면: Segmentation Fault                         │   │
│  │                                                         │   │
│  │ b. 물리 프레임 할당                                     │   │
│  │    - 빈 프레임 있으면 사용                              │   │
│  │    - 없으면 기존 페이지 교체 (Page Replacement)         │   │
│  │                                                         │   │
│  │ c. 디스크에서 페이지 로드                               │   │
│  │                                                         │   │
│  │ d. Page Table 업데이트 (Valid = 1)                      │   │
│  │                                                         │   │
│  │ e. 프로세스 재실행                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Page Fault 종류:                                               │
│  • Minor: 페이지가 이미 메모리에 있음 (공유 페이지 등)         │
│  • Major: 디스크에서 로드 필요 (매우 느림, ~10ms)              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 메모리 매핑

```
┌─────────────────────────────────────────────────────────────────┐
│                    Memory Mapped File                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  일반 파일 I/O:                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ App Buffer ←── Kernel Buffer ←── Disk                   │   │
│  │             copy              read                       │   │
│  │ (2번 복사)                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Memory Mapped I/O:                                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  Virtual Address Space                                  │   │
│  │  ┌───────────────────────────────────┐                 │   │
│  │  │ ... │ Mapped Region │ ...         │                 │   │
│  │  └───────────┬───────────────────────┘                 │   │
│  │              │                                          │   │
│  │              │ Page Table                               │   │
│  │              ▼                                          │   │
│  │  ┌───────────────────────────────────┐                 │   │
│  │  │        Page Cache                  │                 │   │
│  │  └───────────────────────────────────┘                 │   │
│  │              ▲                                          │   │
│  │              │ Demand Paging                            │   │
│  │              │                                          │   │
│  │  ┌───────────────────────────────────┐                 │   │
│  │  │           Disk File                │                 │   │
│  │  └───────────────────────────────────┘                 │   │
│  │                                                         │   │
│  │  장점:                                                  │   │
│  │  • Zero-copy (복사 없음)                               │   │
│  │  • 파일을 배열처럼 접근                                │   │
│  │  • OS가 캐싱 관리                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 메모리 매핑 코드

```cpp
// Windows
HANDLE hFile = CreateFile(...);
HANDLE hMapping = CreateFileMapping(hFile, NULL, PAGE_READONLY, 0, 0, NULL);
void* pData = MapViewOfFile(hMapping, FILE_MAP_READ, 0, 0, 0);
// pData를 포인터로 직접 접근
UnmapViewOfFile(pData);

// POSIX
int fd = open("file.dat", O_RDONLY);
void* pData = mmap(NULL, size, PROT_READ, MAP_PRIVATE, fd, 0);
// pData 사용
munmap(pData, size);
```

---

## 다음 단계

[UE Platform 모듈](05-ue-platform.md)에서 언리얼의 플랫폼 추상화를 알아봅니다.


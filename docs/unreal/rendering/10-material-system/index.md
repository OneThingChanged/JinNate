# Ch.10 머티리얼 시스템

UE 머티리얼 아키텍처, 노드 그래프, 컴파일 과정, 최적화 기법을 분석합니다.

---

## 개요

머티리얼은 표면의 시각적 특성을 정의합니다. UE는 노드 기반 에디터로 복잡한 머티리얼을 직관적으로 제작할 수 있게 합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    머티리얼 시스템 아키텍처                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Material Editor                       │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐     │   │
│  │  │ Texture │→ │ Multiply│→ │  Lerp   │→ │ Base    │     │   │
│  │  │ Sample  │  │         │  │         │  │ Color   │     │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘     │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │ 컴파일                              │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    HLSL 코드 생성                         │   │
│  │  float3 BaseColor = Texture.Sample(UV) * Param;         │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Shader Permutations                   │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                  │   │
│  │  │ BasePass│  │DepthPass│  │ Shadow  │  ...             │   │
│  │  │  PS     │  │  PS     │  │  Pass   │                  │   │
│  │  └─────────┘  └─────────┘  └─────────┘                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 목차

| 문서 | 주제 | 핵심 내용 |
|------|------|----------|
| [01](01-material-overview.md) | 머티리얼 개요 | UMaterial, 도메인, 블렌드 모드 |
| [02](02-material-graph.md) | 머티리얼 그래프 | 노드 시스템, 표현식, 연결 |
| [03](03-material-compilation.md) | 머티리얼 컴파일 | HLSL 생성, 템플릿, 순열 |
| [04](04-material-instance.md) | 머티리얼 인스턴스 | 동적/정적 인스턴스, 파라미터 |
| [05](05-material-optimization.md) | 머티리얼 최적화 | 복잡도, LOD, 성능 |

---

## 머티리얼 핵심 개념

### 클래스 계층

```
┌─────────────────────────────────────────────────────────────────┐
│                    머티리얼 클래스 계층                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                    ┌─────────────────┐                          │
│                    │ UMaterialInterface │ ← 추상 인터페이스      │
│                    └────────┬────────┘                          │
│                             │                                   │
│              ┌──────────────┴──────────────┐                    │
│              │                             │                    │
│              ▼                             ▼                    │
│     ┌─────────────────┐         ┌──────────────────────┐       │
│     │    UMaterial    │         │ UMaterialInstance    │       │
│     │                 │         │                      │       │
│     │ 마스터 머티리얼  │         │ 인스턴스 (파라미터)   │       │
│     └────────┬────────┘         └──────────┬───────────┘       │
│              │                             │                    │
│              │                    ┌────────┴────────┐           │
│              │                    │                 │           │
│              │                    ▼                 ▼           │
│              │         ┌────────────────┐ ┌────────────────┐   │
│              │         │ UMaterialInst  │ │ UMaterialInst  │   │
│              │         │ Constant       │ │ Dynamic        │   │
│              │         │ (정적, 빠름)   │ │ (런타임 변경)  │   │
│              │         └────────────────┘ └────────────────┘   │
│              │                                                  │
│              ▼                                                  │
│     ┌─────────────────┐                                         │
│     │FMaterialResource│ ← 컴파일된 셰이더                        │
│     │                 │                                         │
│     │ - Shader Map    │                                         │
│     │ - Uniform Data  │                                         │
│     └─────────────────┘                                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 머티리얼 속성

```cpp
// 머티리얼 기본 속성
class UMaterial : public UMaterialInterface
{
    // 머티리얼 도메인
    EMaterialDomain MaterialDomain;  // Surface, DeferredDecal, Volume, etc.

    // 블렌드 모드
    EBlendMode BlendMode;  // Opaque, Masked, Translucent, Additive

    // 셰이딩 모델
    EMaterialShadingModel ShadingModel;  // DefaultLit, Unlit, Subsurface, etc.

    // 양면 렌더링
    uint8 TwoSided : 1;

    // 와이어프레임
    uint8 Wireframe : 1;

    // 디더드 LOD 전환
    uint8 DitheredLODTransition : 1;

    // 표현식 (노드)
    TArray<UMaterialExpression*> Expressions;

    // 출력 핀 연결
    FColorMaterialInput BaseColor;
    FScalarMaterialInput Metallic;
    FScalarMaterialInput Roughness;
    FVectorMaterialInput Normal;
    // ...
};
```

---

## 머티리얼 도메인

### 도메인 타입

```
┌────────────────────────────────────────────────────────────────┐
│                    머티리얼 도메인                              │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  도메인              용도                   출력               │
│  ─────────────────  ─────────────────────  ─────────────────  │
│  Surface            일반 메시 표면          Base Color, Normal │
│                                            Metallic, Roughness│
│                                                                │
│  Deferred Decal     디퍼드 데칼            선택적 채널 출력    │
│                                                                │
│  Light Function     광원 함수              스칼라 (밝기)      │
│                                                                │
│  Volume             볼륨 렌더링            Albedo, Extinction │
│                                                                │
│  Post Process       포스트 프로세스        Emissive Color     │
│                                                                │
│  User Interface     UI 렌더링              Final Color        │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## 셰이딩 모델

### 지원 셰이딩 모델

```
┌────────────────────────────────────────────────────────────────┐
│                    셰이딩 모델                                  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  모델                  특징                   G-Buffer 사용    │
│  ───────────────────  ─────────────────────  ─────────────    │
│  Default Lit          표준 PBR               기본              │
│  Unlit                라이팅 없음            최소              │
│  Subsurface           피부, 왁스 등          SSS 프로파일      │
│  Subsurface Profile   프로파일 기반 SSS      SSS 데이터        │
│  Preintegrated Skin   사전 계산 피부         SSS 프로파일      │
│  Clear Coat           클리어 코트 (자동차)   추가 레이어       │
│  Two Sided Foliage    식물 양면 라이팅       별도 처리         │
│  Hair                 머리카락 (Kajiya-Kay)  Aniso 데이터     │
│  Cloth                천 (Ashikhmin)         Fuzz Color       │
│  Eye                  눈 (각막 굴절)         특수 처리         │
│  SingleLayerWater     수면 (단일 레이어)     수면 전용         │
│  From Material Expr   커스텀 (표현식)        가변              │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## 머티리얼 파이프라인

### 에디터에서 렌더링까지

```
┌─────────────────────────────────────────────────────────────────┐
│                    머티리얼 파이프라인                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 에디터에서 노드 그래프 편집                                  │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  [TextureSample] → [Multiply] → [BaseColor]         │    │
│     └────────────────────────┬────────────────────────────┘    │
│                              │                                  │
│  2. 컴파일 트리거 (저장, 적용)  │                                  │
│                              ▼                                  │
│  3. 표현식 트리 순회                                            │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  각 노드의 Compile() 호출                            │    │
│     │  → HLSL 코드 조각 생성                               │    │
│     └────────────────────────┬────────────────────────────┘    │
│                              │                                  │
│  4. 머티리얼 템플릿에 삽입      ▼                                  │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  MaterialTemplate.usf + 생성된 코드 = 완전한 셰이더  │    │
│     └────────────────────────┬────────────────────────────┘    │
│                              │                                  │
│  5. 패스별 셰이더 컴파일       ▼                                  │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  BasePass, DepthPass, ShadowPass, ... 각각 컴파일    │    │
│     └────────────────────────┬────────────────────────────┘    │
│                              │                                  │
│  6. 런타임 렌더링             ▼                                  │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  FMeshDrawCommand가 적절한 셰이더 바인딩             │    │
│     └─────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 학습 순서

1. **머티리얼 개요** - 클래스 구조, 도메인, 셰이딩 모델
2. **머티리얼 그래프** - 노드 시스템, 표현식 타입
3. **머티리얼 컴파일** - HLSL 생성, 템플릿 시스템
4. **머티리얼 인스턴스** - 파라미터화, 동적/정적 인스턴스
5. **머티리얼 최적화** - 복잡도 관리, LOD, 성능

---

## 참고 자료

- [UE 머티리얼 문서](https://docs.unrealengine.com/5.0/en-US/unreal-engine-materials/)
- [원문 시리즈 (중국어)](https://www.cnblogs.com/timlly/p/13512787.html)

# Ch.09 RHI 시스템

RHI(Rendering Hardware Interface)의 아키텍처와 크로스 플랫폼 그래픽스 추상화를 분석합니다.

---

## 개요

RHI는 UE의 그래픽스 API 추상화 계층입니다. DirectX, Vulkan, Metal 등 다양한 플랫폼을 단일 인터페이스로 통합합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    RHI 시스템 아키텍처                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    렌더링 코드                            │   │
│  │  (Renderer, MeshDraw, PostProcess 등)                   │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    RHI 인터페이스                         │   │
│  │  FRHICommandList, FRHIResource, FRHITexture...          │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                     │
│           ┌───────────────┼───────────────┐                     │
│           │               │               │                     │
│           ▼               ▼               ▼                     │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │  D3D12RHI    │ │  VulkanRHI   │ │   MetalRHI   │            │
│  │              │ │              │ │              │            │
│  │  DirectX 12  │ │   Vulkan     │ │    Metal     │            │
│  └──────────────┘ └──────────────┘ └──────────────┘            │
│                                                                 │
│  기타 RHI: D3D11, OpenGL, AGXRHI (Apple Silicon)               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 목차

| 문서 | 주제 | 핵심 내용 |
|------|------|----------|
| [01](01-rhi-overview.md) | RHI 개요 | 아키텍처, 동적 RHI, 초기화 |
| [02](02-rhi-resources.md) | RHI 리소스 | 텍스처, 버퍼, 렌더 타겟 |
| [03](03-command-list.md) | 커맨드 리스트 | 커맨드 인코딩, 제출, 동기화 |
| [04](04-pipeline-state.md) | 파이프라인 스테이트 | PSO, 그래픽스/컴퓨트 파이프라인 |
| [05](05-platform-rhi.md) | 플랫폼별 RHI | D3D12, Vulkan, Metal 구현 |

---

## RHI 핵심 개념

### 왜 RHI인가?

```
┌─────────────────────────────────────────────────────────────────┐
│                    그래픽스 API 추상화 필요성                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  플랫폼별 네이티브 API:                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Windows     : DirectX 11/12                            │   │
│  │  Windows/Linux: Vulkan                                   │   │
│  │  macOS/iOS   : Metal                                     │   │
│  │  Android     : Vulkan / OpenGL ES                        │   │
│  │  Web         : WebGPU                                    │   │
│  │  Console     : 플랫폼 전용 API                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  RHI 없이:                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  #if PLATFORM_WINDOWS                                   │   │
│  │      D3D12CreateDevice(...)                             │   │
│  │  #elif PLATFORM_MAC                                     │   │
│  │      MTLCreateSystemDefaultDevice()                     │   │
│  │  #elif PLATFORM_LINUX                                   │   │
│  │      vkCreateInstance(...)                              │   │
│  │  #endif                                                 │   │
│  │  → 모든 렌더링 코드에 #if 분기 필요                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  RHI 사용:                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  // 플랫폼 독립적 코드                                    │   │
│  │  FRHITexture2D* Texture = RHICreateTexture2D(...);      │   │
│  │  RHICmdList.DrawPrimitive(...);                         │   │
│  │  → 깔끔하고 이식 가능한 코드                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### RHI 클래스 계층

```cpp
// 기본 리소스 클래스
class FRHIResource
{
    // 참조 카운팅
    mutable int32 NumRefs;

public:
    virtual ~FRHIResource() {}
    uint32 AddRef() const;
    uint32 Release() const;
};

// 텍스처 리소스
class FRHITexture : public FRHIResource
{
public:
    virtual FIntVector GetSizeXYZ() const = 0;
    virtual uint32 GetNumMips() const = 0;
    virtual EPixelFormat GetFormat() const = 0;
};

class FRHITexture2D : public FRHITexture
{
    uint32 SizeX, SizeY;
    uint32 NumMips;
    uint32 NumSamples;
    EPixelFormat Format;
};

// 버퍼 리소스
class FRHIBuffer : public FRHIResource
{
    uint32 Size;
    EBufferUsageFlags Usage;
};

// 셰이더
class FRHIShader : public FRHIResource
{
    TArray<uint8> Code;
    FSHAHash Hash;
};

class FRHIVertexShader : public FRHIShader {};
class FRHIPixelShader : public FRHIShader {};
class FRHIComputeShader : public FRHIShader {};
```

---

## 동적 RHI

### RHI 선택 메커니즘

```
┌─────────────────────────────────────────────────────────────────┐
│                    동적 RHI 선택                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  엔진 시작                                                       │
│       │                                                         │
│       ▼                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  플랫폼 감지                                             │   │
│  │  - 운영체제 확인                                         │   │
│  │  - GPU 벤더/모델 확인                                    │   │
│  │  - 드라이버 버전 확인                                    │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  사용자 설정 / 커맨드라인 확인                            │   │
│  │  -d3d12, -vulkan, -opengl 등                            │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  RHI 모듈 로드                                           │   │
│  │  FDynamicRHI* RHI = PlatformCreateDynamicRHI();         │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  GDynamicRHI 전역 변수에 저장                             │   │
│  │  → 이후 모든 RHI 호출은 이 인스턴스 사용                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 플랫폼별 기본 RHI

```
┌────────────────────────────────────────────────────────────────┐
│                    플랫폼별 기본 RHI                            │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  플랫폼          기본 RHI       대체 옵션                      │
│  ─────────────  ───────────   ────────────────────────────    │
│  Windows 10+    D3D12         D3D11, Vulkan, OpenGL           │
│  Windows 7      D3D11         OpenGL                          │
│  macOS          Metal         (없음)                          │
│  iOS            Metal         (없음)                          │
│  Linux          Vulkan        OpenGL                          │
│  Android        Vulkan        OpenGL ES                       │
│  PS5            AGC           (플랫폼 전용)                   │
│  Xbox Series    D3D12         (플랫폼 전용)                   │
│  Switch         NVN           Vulkan                          │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## RHI 스레딩 모델

### 커맨드 제출 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                    RHI 스레딩 모델                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Game Thread          Render Thread         RHI Thread         │
│      │                     │                    │              │
│      │   ENQUEUE_RENDER   │                    │              │
│      │ ─────────────────> │                    │              │
│      │                     │                    │              │
│      │                     │   RHI Commands    │              │
│      │                     │ ────────────────> │              │
│      │                     │                    │              │
│      │                     │                    │  GPU         │
│      │                     │                    │ ────────>    │
│      │                     │                    │              │
│                                                                 │
│  Immediate Context vs Parallel Context:                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  Immediate: 단일 스레드, 순차 실행                       │   │
│  │  Parallel:  멀티 스레드, 병렬 커맨드 생성                 │   │
│  │                                                         │   │
│  │  ┌────────┐ ┌────────┐ ┌────────┐                      │   │
│  │  │Worker 1│ │Worker 2│ │Worker 3│  병렬 커맨드 생성      │   │
│  │  └───┬────┘ └───┬────┘ └───┬────┘                      │   │
│  │      │          │          │                            │   │
│  │      └──────────┼──────────┘                            │   │
│  │                 ▼                                       │   │
│  │         ┌──────────────┐                                │   │
│  │         │ Command List │  병합 후 제출                   │   │
│  │         │   Merge      │                                │   │
│  │         └──────────────┘                                │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 성능 특성

### Modern API vs Legacy API

```
┌────────────────────────────────────────────────────────────────┐
│                    API 세대별 특성                              │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  Legacy API (D3D11, OpenGL):                                   │
│  ┌────────────────────────────────────────────────────────┐   │
│  │  + 단순한 프로그래밍 모델                               │   │
│  │  + 드라이버가 많은 것을 자동 처리                       │   │
│  │  - 암묵적 상태 관리 → 드라이버 오버헤드                 │   │
│  │  - 싱글 스레드 커맨드 제출                              │   │
│  │  - 숨겨진 메모리 관리                                   │   │
│  └────────────────────────────────────────────────────────┘   │
│                                                                │
│  Modern API (D3D12, Vulkan, Metal):                            │
│  ┌────────────────────────────────────────────────────────┐   │
│  │  + 명시적 제어 → 낮은 드라이버 오버헤드                 │   │
│  │  + 멀티스레드 커맨드 생성                               │   │
│  │  + 명시적 메모리 관리                                   │   │
│  │  + PSO 사전 컴파일                                      │   │
│  │  - 복잡한 프로그래밍 모델                               │   │
│  │  - 잘못 사용하면 오히려 느림                            │   │
│  └────────────────────────────────────────────────────────┘   │
│                                                                │
│  UE RHI의 역할:                                                │
│  - Modern API의 성능 이점 활용                                 │
│  - 복잡성은 RHI 레이어에서 관리                                │
│  - 상위 렌더링 코드는 단순하게 유지                            │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## 학습 순서

1. **RHI 개요** - 아키텍처, 동적 RHI, 초기화 과정
2. **RHI 리소스** - 텍스처, 버퍼, 뷰 생성과 관리
3. **커맨드 리스트** - 커맨드 인코딩, 배리어, 동기화
4. **파이프라인 스테이트** - PSO 생성, 캐싱, 상태 관리
5. **플랫폼별 RHI** - D3D12, Vulkan, Metal 구현 상세

---

## 참고 자료

- [UE RHI 문서](https://docs.unrealengine.com/5.0/en-US/render-hardware-interface/)
- [원문 시리즈 (중국어)](https://www.cnblogs.com/timlly/p/13512787.html)

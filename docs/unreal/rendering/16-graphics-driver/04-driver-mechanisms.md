# 드라이버 메커니즘

GPU 스케줄링과 TDR 메커니즘을 설명합니다.

---

## GPU 스케줄링

### 다중 앱 스케줄링

```
┌─────────────────────────────────────────────────────────────────┐
│                    GPU 스케줄링                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  여러 앱이 GPU를 공유:                                          │
│                                                                 │
│  ┌─────┐  ┌─────┐  ┌─────┐                                     │
│  │Game │  │Video│  │ DWM │   ← 애플리케이션                    │
│  └──┬──┘  └──┬──┘  └──┬──┘                                     │
│     │        │        │                                         │
│     └────────┼────────┘                                         │
│              ▼                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              GPU Scheduler                               │   │
│  │                                                         │   │
│  │  우선순위 기반 스케줄링:                                │   │
│  │  1. Foreground App (높음)                               │   │
│  │  2. Background App (낮음)                               │   │
│  │  3. System (DWM) (중간)                                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│              │                                                   │
│              ▼                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              GPU Engine                                  │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │ Time Slice │ Time Slice │ Time Slice │ ...       │   │   │
│  │  │   Game     │   Video    │   DWM      │           │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 컨텍스트 스위칭

```
┌─────────────────────────────────────────────────────────────────┐
│                    GPU 컨텍스트 스위칭                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  컨텍스트 A 실행 중:                                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  레지스터, 파이프라인 상태, 메모리 매핑                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                          │                                      │
│                          ▼ 선점 신호                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  1. 현재 작업 완료 대기 (또는 중단점까지)               │   │
│  │  2. 컨텍스트 A 상태 저장 (GPU 메모리)                   │   │
│  │  3. 컨텍스트 B 상태 로드                                │   │
│  │  4. 컨텍스트 B 실행 시작                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  비용:                                                          │
│  • 수십~수백 마이크로초                                        │
│  • 파이프라인 드레인 필요                                      │
│  • 캐시 무효화 가능                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## TDR (Timeout Detection and Recovery)

GPU 행이 감지되면 복구를 시도합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    TDR 동작 과정                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  정상 동작:                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  App → Command → GPU 처리 → 완료 신호 → 다음 명령      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  행 감지:                                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  App → Command → GPU 처리 중...                         │   │
│  │                     │                                    │   │
│  │                     │ (타임아웃, 기본 2초)               │   │
│  │                     ▼                                    │   │
│  │              TDR 발동!                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  복구 과정:                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  1. 문제 GPU 엔진 식별                                  │   │
│  │  2. 해당 엔진만 리셋 (전체 GPU 아님)                    │   │
│  │  3. 드라이버 상태 재초기화                              │   │
│  │  4. 해당 앱에 에러 반환                                 │   │
│  │  5. 다른 앱은 계속 실행                                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  결과:                                                          │
│  • 해당 앱: Device Lost 에러, 복구 필요                        │
│  • 시스템: 계속 동작                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### TDR 레지스트리 설정 (Windows)

```
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\GraphicsDrivers

TdrDelay: 타임아웃 시간 (기본 2초)
TdrDdiDelay: DDI 콜백 타임아웃 (기본 5초)
TdrLevel: TDR 동작 모드
  0: Off
  1: Bug Check (블루스크린)
  2: Recover (기본, 복구 시도)
```

---

## 다음 단계

[게임 엔진 통합](05-driver-optimization.md)에서 UE 드라이버 통합을 알아봅니다.

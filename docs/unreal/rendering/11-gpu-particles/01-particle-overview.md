# 01. 파티클 시스템 개요

파티클 시스템의 기본 개념, 역사, UE에서의 구현을 분석합니다.

---

## 파티클 시스템이란?

### 기본 개념

```
┌─────────────────────────────────────────────────────────────────┐
│                    파티클 시스템 개념                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  파티클 시스템 = 대량의 작은 요소를 시뮬레이션하여               │
│                 복잡한 시각 효과를 생성하는 기술                 │
│                                                                 │
│  활용 분야:                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  자연 현상         게임 효과          환경 효과          │   │
│  │  ───────────      ───────────       ───────────        │   │
│  │  - 불, 연기        - 폭발            - 비, 눈           │   │
│  │  - 불꽃           - 마법 이펙트      - 안개, 먼지       │   │
│  │  - 물 스플래시     - 총구 화염       - 낙엽             │   │
│  │  - 먼지, 모래      - 데미지 숫자     - 반딧불           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  핵심 요소:                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Emitter: 파티클을 생성하는 소스                        │   │
│  │  Particle: 개별 요소 (위치, 속도, 색상 등)              │   │
│  │  Simulation: 물리 법칙에 따른 업데이트                   │   │
│  │  Renderer: 시각적 표현 (Billboard, Mesh 등)             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 파티클 속성

```cpp
// 기본 파티클 속성
struct FParticleAttributes
{
    // === 위치/운동 ===
    FVector Position;        // 현재 위치
    FVector Velocity;        // 속도
    FVector Acceleration;    // 가속도

    // === 생명주기 ===
    float Age;               // 현재 나이 (초)
    float Lifetime;          // 총 수명 (초)
    bool bAlive;             // 살아있는지

    // === 시각적 ===
    FLinearColor Color;      // RGBA 색상
    float Size;              // 크기 (또는 스케일)
    float Rotation;          // Z축 회전

    // === 물리 ===
    float Mass;              // 질량
    float Drag;              // 공기 저항

    // === 랜덤화 ===
    float RandomSeed;        // 랜덤 시드
    int32 UniqueID;          // 고유 ID
};
```

---

## UE 파티클 시스템 역사

### 발전 과정

```
┌─────────────────────────────────────────────────────────────────┐
│                    UE 파티클 시스템 역사                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  UE3 시대:                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Cascade 파티클 시스템                                  │   │
│  │  - 완전 CPU 기반                                        │   │
│  │  - 모듈 기반 구조                                       │   │
│  │  - LOD 지원                                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  UE4 초기 (4.0-4.19):                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Cascade 개선                                           │   │
│  │  - GPU 파티클 추가 (제한적)                             │   │
│  │  - Vector Field 지원                                    │   │
│  │  - 라이트 파티클                                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  UE4 후기 (4.20+):                                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Niagara 도입                                           │   │
│  │  - 완전히 새로운 아키텍처                               │   │
│  │  - 노드 기반 그래프                                     │   │
│  │  - GPU 시뮬레이션                                       │   │
│  │  - 데이터 인터페이스                                    │   │
│  │  - Cascade와 공존                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  UE5:                                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Niagara가 표준                                         │   │
│  │  - Cascade 지원 종료 예정                               │   │
│  │  - 시뮬레이션 스테이지                                  │   │
│  │  - 개선된 성능                                          │   │
│  │  - Fluid Simulation                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## CPU vs GPU 시뮬레이션

### 비교

```
┌─────────────────────────────────────────────────────────────────┐
│                    CPU vs GPU 파티클                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  CPU 시뮬레이션 (Cascade, Niagara CPU):                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  장점:                                                  │   │
│  │  - 복잡한 로직 처리 용이                                │   │
│  │  - 게임 로직과 상호작용 쉬움                            │   │
│  │  - 디버깅 용이                                          │   │
│  │  - 플랫폼 호환성                                        │   │
│  │                                                         │   │
│  │  단점:                                                  │   │
│  │  - 파티클 수 제한 (수천 개)                             │   │
│  │  - 게임 스레드 부하                                     │   │
│  │  - 데이터 전송 오버헤드                                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  GPU 시뮬레이션 (Niagara GPU):                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  장점:                                                  │   │
│  │  - 대량 파티클 (수십만~수백만)                          │   │
│  │  - CPU 부하 없음                                        │   │
│  │  - 병렬 처리 효율                                       │   │
│  │  - 렌더링과 통합 (데이터 GPU에 유지)                    │   │
│  │                                                         │   │
│  │  단점:                                                  │   │
│  │  - 복잡한 분기 비효율                                   │   │
│  │  - CPU 데이터 접근 어려움                               │   │
│  │  - 디버깅 어려움                                        │   │
│  │  - 플랫폼 요구사항                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  선택 기준:                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  CPU 사용: 복잡한 게임 상호작용, 적은 파티클             │   │
│  │  GPU 사용: 대량 파티클, 시각 효과 중심, 성능 중요        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                    시뮬레이션 데이터 흐름                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  CPU 시뮬레이션:                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  [CPU Buffer]                                           │   │
│  │       │                                                 │   │
│  │       │ Simulate (Game Thread)                          │   │
│  │       ▼                                                 │   │
│  │  [CPU Buffer (updated)]                                 │   │
│  │       │                                                 │   │
│  │       │ Upload to GPU                                   │   │
│  │       ▼                                                 │   │
│  │  [GPU Buffer] ──→ Render                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  GPU 시뮬레이션:                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  [GPU Buffer]                                           │   │
│  │       │                                                 │   │
│  │       │ Simulate (Compute Shader)                       │   │
│  │       ▼                                                 │   │
│  │  [GPU Buffer (updated)]                                 │   │
│  │       │                                                 │   │
│  │       │ (데이터 이동 없음)                               │   │
│  │       ▼                                                 │   │
│  │  [GPU Buffer] ──→ Render                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Cascade 시스템 (레거시)

### Cascade 구조

```cpp
// Cascade 파티클 시스템
class UParticleSystem : public UFXSystemAsset
{
    // Emitter 목록
    UPROPERTY()
    TArray<UParticleEmitter*> Emitters;

    // LOD 설정
    UPROPERTY()
    TArray<FParticleLODLevel> LODLevels;

    // 전역 설정
    UPROPERTY()
    float UpdateTime_FPS;

    UPROPERTY()
    int32 WarmupTime;
};

// Cascade Emitter
class UParticleEmitter : public UObject
{
    // 모듈 스택
    TArray<UParticleModule*> SpawnModules;
    TArray<UParticleModule*> UpdateModules;

    // 렌더러
    UParticleModuleTypeDataBase* TypeDataModule;  // Sprite, Mesh, Beam 등
};

// Cascade 모듈 예시
class UParticleModuleVelocity : public UParticleModuleVelocityBase
{
    UPROPERTY()
    FRawDistributionVector StartVelocity;  // 초기 속도 분포

    UPROPERTY()
    FRawDistributionFloat StartVelocityRadial;  // 방사형 속도
};
```

### Cascade 한계

```
┌─────────────────────────────────────────────────────────────────┐
│                    Cascade의 한계                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 확장성 부족                                                 │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  - 고정된 모듈 세트                                  │    │
│     │  - 커스텀 동작 구현 어려움                           │    │
│     │  - 엔진 코드 수정 필요                               │    │
│     └─────────────────────────────────────────────────────┘    │
│                                                                 │
│  2. 성능 제한                                                   │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  - CPU 의존적                                        │    │
│     │  - 대량 파티클 비효율                                │    │
│     │  - GPU 파티클 제한적                                 │    │
│     └─────────────────────────────────────────────────────┘    │
│                                                                 │
│  3. 데이터 접근                                                 │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  - 외부 데이터 접근 어려움                           │    │
│     │  - 다른 시스템과 연동 제한                           │    │
│     └─────────────────────────────────────────────────────┘    │
│                                                                 │
│  → Niagara가 이 모든 한계를 해결                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Niagara 개요

### Niagara 특징

```
┌─────────────────────────────────────────────────────────────────┐
│                    Niagara 핵심 특징                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 모듈러 스택 시스템                                          │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  - 자유롭게 조합 가능한 모듈                         │    │
│     │  - 커스텀 모듈 생성 지원                             │    │
│     │  - 스크래치 패드로 빠른 프로토타이핑                 │    │
│     └─────────────────────────────────────────────────────┘    │
│                                                                 │
│  2. GPU 시뮬레이션                                              │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  - Compute Shader 기반                               │    │
│     │  - 수십만 파티클 처리                                │    │
│     │  - 효율적 메모리 관리                                │    │
│     └─────────────────────────────────────────────────────┘    │
│                                                                 │
│  3. 데이터 인터페이스                                           │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  - 외부 데이터 접근 (메시, 텍스처, 볼륨 등)          │    │
│     │  - 충돌, 오디오, 카메라 등                           │    │
│     │  - 커스텀 데이터 인터페이스                          │    │
│     └─────────────────────────────────────────────────────┘    │
│                                                                 │
│  4. 시뮬레이션 스테이지                                         │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  - 다단계 시뮬레이션                                 │    │
│     │  - Grid 기반 시뮬레이션                              │    │
│     │  - 유체, 천 등 복잡한 효과                           │    │
│     └─────────────────────────────────────────────────────┘    │
│                                                                 │
│  5. 이벤트 시스템                                               │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  - 파티클 간 통신                                    │    │
│     │  - 충돌 이벤트, 소멸 이벤트                          │    │
│     │  - Emitter 간 이벤트                                 │    │
│     └─────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Niagara 계층

```cpp
// Niagara 시스템 계층
// System > Emitter > Module

// 시스템 - 최상위 컨테이너
class UNiagaraSystem : public UFXSystemAsset
{
    UPROPERTY()
    TArray<FNiagaraEmitterHandle> EmitterHandles;

    UPROPERTY()
    FNiagaraUserRedirectionParameterStore ExposedParameters;

    UPROPERTY()
    bool bFixedBounds;
    UPROPERTY()
    FBox FixedBounds;
};

// Emitter - 파티클 생성/관리 단위
class UNiagaraEmitter : public UObject
{
    // Emitter 속성
    UPROPERTY()
    ENiagaraSimTarget SimTarget;  // CPU or GPU

    // 스크립트 (모듈 스택)
    UPROPERTY()
    UNiagaraScript* EmitterSpawnScript;
    UPROPERTY()
    UNiagaraScript* EmitterUpdateScript;
    UPROPERTY()
    UNiagaraScript* ParticleSpawnScript;
    UPROPERTY()
    UNiagaraScript* ParticleUpdateScript;

    // 렌더러
    UPROPERTY()
    TArray<UNiagaraRendererProperties*> RendererProperties;
};

// Module - 개별 동작 단위
class UNiagaraScript : public UObject
{
    UPROPERTY()
    FNiagaraVMExecutableData CachedScriptVM;  // 컴파일된 VM 코드

    UPROPERTY()
    FNiagaraVMExecutableDataId CachedScriptVMId;
};
```

---

## 요약

파티클 시스템 개요:

1. **개념** - 대량의 작은 요소로 시각 효과 생성
2. **Cascade** - UE4 레거시, CPU 기반, 고정 모듈
3. **Niagara** - UE5 표준, GPU 지원, 완전 확장 가능
4. **CPU vs GPU** - 상호작용 vs 대량 처리
5. **선택 기준** - 복잡도, 파티클 수, 상호작용 필요성

Niagara는 현대 게임의 파티클 요구사항을 충족하는 강력한 시스템입니다.

---

## 참고 자료

- [Niagara Overview](https://docs.unrealengine.com/5.0/en-US/overview-of-niagara/)
- [원문 시리즈 (중국어)](https://www.cnblogs.com/timlly/p/13512787.html)

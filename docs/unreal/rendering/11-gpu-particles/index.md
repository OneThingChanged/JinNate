# Ch.11 GPU 파티클 시스템

Niagara 파티클 시스템의 아키텍처, GPU 시뮬레이션, 렌더링 파이프라인을 분석합니다.

---

## 개요

파티클 시스템은 불, 연기, 비, 마법 효과 등 다양한 시각 효과를 구현합니다. UE5의 Niagara는 GPU 기반 고성능 파티클 시스템입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    Niagara 시스템 아키텍처                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Niagara System                        │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │               Emitter 1                          │    │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐            │    │   │
│  │  │  │  Spawn  │→│ Update  │→│ Render  │            │    │   │
│  │  │  │ Module  │ │ Module  │ │ Module  │            │    │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘            │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │               Emitter 2                          │    │   │
│  │  │  ...                                             │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Simulation                            │   │
│  │  ┌─────────────┐              ┌─────────────┐           │   │
│  │  │ CPU Sim     │     또는     │ GPU Sim     │           │   │
│  │  │ (Game Thr)  │              │ (Compute)   │           │   │
│  │  └─────────────┘              └─────────────┘           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Rendering                             │   │
│  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐        │   │
│  │  │ Sprite │  │  Mesh  │  │ Ribbon │  │ Light  │        │   │
│  │  └────────┘  └────────┘  └────────┘  └────────┘        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 목차

| 문서 | 주제 | 핵심 내용 |
|------|------|----------|
| [01](01-particle-overview.md) | 파티클 시스템 개요 | Cascade vs Niagara, 개념 |
| [02](02-niagara-architecture.md) | Niagara 아키텍처 | System, Emitter, Module |
| [03](03-gpu-simulation.md) | GPU 시뮬레이션 | Compute Shader, 데이터 인터페이스 |
| [04](04-particle-rendering.md) | 파티클 렌더링 | Sprite, Mesh, Ribbon, Light |
| [05](05-particle-optimization.md) | 파티클 최적화 | LOD, 컬링, 성능 |

---

## Cascade vs Niagara

### 시스템 비교

```
┌─────────────────────────────────────────────────────────────────┐
│                    Cascade vs Niagara                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Cascade (레거시):                                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  - UE4 기본 파티클 시스템                               │   │
│  │  - CPU 기반 시뮬레이션                                  │   │
│  │  - 고정된 모듈 세트                                     │   │
│  │  - 제한된 확장성                                        │   │
│  │  - 단순한 효과에 적합                                   │   │
│  │  - UE5에서 Deprecated                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Niagara:                                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  - UE4.20+에서 도입                                     │   │
│  │  - GPU 시뮬레이션 지원                                  │   │
│  │  - 모듈러 스택 시스템                                   │   │
│  │  - 완전한 확장성 (커스텀 모듈)                          │   │
│  │  - 데이터 인터페이스 (외부 데이터 접근)                 │   │
│  │  - 시뮬레이션 스테이지                                  │   │
│  │  - 이벤트 시스템                                        │   │
│  │  - UE5 표준                                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  성능 비교:                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  파티클 수        Cascade       Niagara (GPU)           │   │
│  │  ────────────    ───────────   ────────────────        │   │
│  │  1,000           10ms CPU      0.5ms GPU               │   │
│  │  10,000          100ms+ CPU    2ms GPU                 │   │
│  │  100,000+        불가능        10ms GPU                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 핵심 개념

### 파티클 생명주기

```
┌─────────────────────────────────────────────────────────────────┐
│                    파티클 생명주기                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. Spawn (생성)                                                │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  - 파티클 초기화                                     │    │
│     │  - 위치, 속도, 색상 등 초기값 설정                   │    │
│     │  - Spawn Rate, Burst 등으로 제어                    │    │
│     └────────────────────────┬────────────────────────────┘    │
│                              │                                  │
│  2. Update (업데이트)         ▼                                  │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  매 프레임 실행:                                     │    │
│     │  - 힘 적용 (중력, 드래그, 노이즈)                    │    │
│     │  - 속도 → 위치 적분                                  │    │
│     │  - 수명 감소                                         │    │
│     │  - 색상/크기 변화                                    │    │
│     │  - 충돌 처리                                         │    │
│     └────────────────────────┬────────────────────────────┘    │
│                              │                                  │
│  3. Render (렌더링)           ▼                                  │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  - Sprite/Mesh/Ribbon으로 시각화                     │    │
│     │  - 정렬 (반투명)                                     │    │
│     │  - GPU 드로우                                        │    │
│     └────────────────────────┬────────────────────────────┘    │
│                              │                                  │
│  4. Death (소멸)              ▼                                  │
│     ┌─────────────────────────────────────────────────────┐    │
│     │  - 수명 종료 또는 Kill 조건                          │    │
│     │  - 파티클 슬롯 재활용                                │    │
│     └─────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 파티클 데이터

```cpp
// 파티클 속성 (Attribute)
struct FNiagaraParticle
{
    // 기본 속성
    FVector3f Position;      // 위치
    FVector3f Velocity;      // 속도
    float Age;               // 현재 나이
    float Lifetime;          // 수명
    float NormalizedAge;     // Age / Lifetime

    // 시각적 속성
    FLinearColor Color;      // 색상
    float SpriteSize;        // 스프라이트 크기
    float SpriteRotation;    // 회전

    // 물리 속성
    float Mass;              // 질량
    FVector3f Acceleration;  // 가속도

    // 렌더링 속성
    int32 RibbonId;          // 리본 ID
    float RibbonWidth;       // 리본 너비

    // 커스텀 속성
    // 사용자 정의 가능
};
```

---

## Niagara 에디터

### 에디터 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                    Niagara 에디터 레이아웃                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┬───────────────────────────────────────┐   │
│  │                 │                                       │   │
│  │   System        │          Preview Viewport             │   │
│  │   Overview      │                                       │   │
│  │                 │     [파티클 미리보기]                  │   │
│  │  ┌───────────┐ │                                       │   │
│  │  │ System    │ │                                       │   │
│  │  │  ├─Emitter│ │                                       │   │
│  │  │  └─Emitter│ │                                       │   │
│  │  └───────────┘ │                                       │   │
│  │                 │                                       │   │
│  ├─────────────────┼───────────────────────────────────────┤   │
│  │                 │                                       │   │
│  │   Selection     │          Stack (Module List)         │   │
│  │   Panel         │                                       │   │
│  │                 │     ┌─────────────────────────┐      │   │
│  │   [선택된       │     │ Emitter Properties      │      │   │
│  │    아이템       │     │ Emitter Spawn           │      │   │
│  │    속성]        │     │ Particle Spawn          │      │   │
│  │                 │     │ Particle Update         │      │   │
│  │                 │     │ Render                  │      │   │
│  │                 │     └─────────────────────────┘      │   │
│  │                 │                                       │   │
│  └─────────────────┴───────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 학습 순서

1. **파티클 개요** - 기본 개념, Cascade vs Niagara
2. **Niagara 아키텍처** - System, Emitter, Module 구조
3. **GPU 시뮬레이션** - Compute Shader 기반 물리
4. **파티클 렌더링** - 다양한 렌더러 타입
5. **파티클 최적화** - LOD, 컬링, 성능 튜닝

---

## 참고 자료

- [UE Niagara 문서](https://docs.unrealengine.com/5.0/en-US/niagara-visual-effects/)
- [원문 시리즈 (중국어)](https://www.cnblogs.com/timlly/p/13512787.html)

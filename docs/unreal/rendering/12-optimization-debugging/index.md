# Ch.12 렌더링 최적화 및 디버깅

렌더링 파이프라인의 성능 최적화와 디버깅 기법을 다룹니다.

---

## 개요

렌더링 최적화는 게임 성능의 핵심입니다. 이 챕터에서는 프로파일링 도구 사용법부터 CPU/GPU 최적화, 메모리 관리, 플랫폼별 최적화까지 실용적인 기법을 다룹니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    렌더링 최적화 파이프라인                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐       │
│  │  측정       │────▶│   분석      │────▶│   최적화    │       │
│  │ Profiling   │     │  Analysis   │     │ Optimization│       │
│  └─────────────┘     └─────────────┘     └──────┬──────┘       │
│         ▲                                        │              │
│         │                                        │              │
│         └────────────────────────────────────────┘              │
│                      반복 (Iterate)                             │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    최적화 대상 영역                        │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │                                                           │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐      │  │
│  │  │  CPU    │  │  GPU    │  │ Memory  │  │Platform │      │  │
│  │  │         │  │         │  │         │  │Specific │      │  │
│  │  ├─────────┤  ├─────────┤  ├─────────┤  ├─────────┤      │  │
│  │  │Draw Call│  │ Shader  │  │ Texture │  │   PC    │      │  │
│  │  │Batching │  │  ALU    │  │Streaming│  │ Console │      │  │
│  │  │Culling  │  │Bandwidth│  │ Pooling │  │ Mobile  │      │  │
│  │  │Threading│  │Fillrate │  │   LOD   │  │   VR    │      │  │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘      │  │
│  │                                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 문서 구성

| 문서 | 주제 | 핵심 내용 |
|------|------|----------|
| [01](01-profiling-tools.md) | 프로파일링 도구 | Unreal Insights, RenderDoc, PIX, 콘솔 명령 |
| [02](02-cpu-optimization.md) | CPU 최적화 | Draw Call, Culling, Batching, 스레딩 |
| [03](03-gpu-optimization.md) | GPU 최적화 | 셰이더, 대역폭, Fillrate, 오버드로우 |
| [04](04-memory-optimization.md) | 메모리 최적화 | 텍스처 스트리밍, 풀링, LOD, 압축 |
| [05](05-platform-optimization.md) | 플랫폼별 최적화 | PC, 콘솔, 모바일, VR 특화 기법 |

---

## 성능 목표 설정

```
┌─────────────────────────────────────────────────────────────────┐
│                     플랫폼별 성능 목표                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 플랫폼      │ 목표 FPS │ 프레임 예산  │ GPU 예산        │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ PC (High)   │   60     │  16.67ms    │ 12-14ms        │   │
│  │ PC (Ultra)  │  120     │   8.33ms    │  6-7ms         │   │
│  │ Console     │   60     │  16.67ms    │ 14-15ms        │   │
│  │ Mobile      │   30     │  33.33ms    │ 25-28ms        │   │
│  │ VR          │   90     │  11.11ms    │  9-10ms        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ※ GPU 예산 = 프레임 예산 - CPU 예산 - 동기화 오버헤드          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 최적화 원칙

### 1. 측정 먼저 (Measure First)

```cpp
// 추측하지 말고 측정하라
// BAD: "이 셰이더가 느릴 것 같아"
// GOOD: 프로파일러로 실제 병목 확인

// Unreal Insights로 GPU 타이밍 확인
SCOPED_GPU_STAT(RHICmdList, MyExpensivePass);
```

### 2. 20-80 법칙

```
┌─────────────────────────────────────────────────────────────────┐
│                      20-80 최적화 법칙                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│     20%의 코드가 80%의 성능 문제를 일으킨다                      │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                                                           │  │
│  │   ████████████████████ 80% 영향                          │  │
│  │   ████ 20% 코드                                          │  │
│  │                                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  → 가장 큰 병목부터 해결                                        │
│  → 작은 최적화 여러 개보다 큰 최적화 하나가 효과적               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3. 트레이드오프 이해

| 최적화 | 장점 | 단점 |
|--------|------|------|
| LOD | 폴리곤 감소 | 품질 저하, 팝핑 |
| Culling | Draw Call 감소 | CPU 오버헤드 |
| Texture Streaming | 메모리 절약 | 로딩 지연 |
| Instancing | 배칭 효율 | 유연성 감소 |

---

## 일반적인 병목 패턴

```
┌─────────────────────────────────────────────────────────────────┐
│                    렌더링 병목 진단 흐름도                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                    ┌─────────────┐                              │
│                    │ FPS가 낮다   │                              │
│                    └──────┬──────┘                              │
│                           │                                     │
│              ┌────────────┴────────────┐                        │
│              ▼                         ▼                        │
│     ┌────────────────┐        ┌────────────────┐                │
│     │ GPU 시간 > CPU │        │ CPU 시간 > GPU │                │
│     │   (GPU Bound)  │        │   (CPU Bound)  │                │
│     └───────┬────────┘        └───────┬────────┘                │
│             │                         │                         │
│     ┌───────┴───────┐         ┌───────┴───────┐                 │
│     ▼               ▼         ▼               ▼                 │
│  ┌──────┐      ┌──────┐   ┌──────┐      ┌──────┐               │
│  │Shader│      │ Fill │   │ Draw │      │ Game │               │
│  │ 복잡 │      │ Rate │   │ Call │      │ Logic│               │
│  └──────┘      └──────┘   └──────┘      └──────┘               │
│     │              │           │              │                 │
│     ▼              ▼           ▼              ▼                 │
│  셰이더       해상도/       배칭/        스레드                  │
│  단순화       오버드로우    컬링         분산                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 핵심 콘솔 명령

```cpp
// 통계 표시
stat fps           // FPS 표시
stat unit          // 프레임 타임 분석
stat gpu           // GPU 통계
stat rhi           // RHI 통계
stat scenerendering // 씬 렌더링 통계

// 시각화
r.VisualizeBuffer   // 버퍼 시각화
ShowFlag.Wireframe  // 와이어프레임
viewmode shadercomplexity // 셰이더 복잡도

// 성능 제한
r.ScreenPercentage  // 해상도 스케일
r.SetRes            // 해상도 설정
```

---

## 참고 자료

- [Unreal Engine Profiling](https://docs.unrealengine.com/profiling-optimization/)
- [GPU Profiling Best Practices](https://developer.nvidia.com/blog)
- [Console Optimization Guide](https://docs.unrealengine.com/console-development/)
